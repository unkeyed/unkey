MAKEFLAGS += -j4



# Detect OS and set GOMAXPROCS accordingly
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    DETECTED_PROCS := $(shell nproc)
else ifeq ($(UNAME_S),Darwin)
    DETECTED_PROCS := $(shell sysctl -n hw.ncpu)
else
    DETECTED_PROCS := 4
endif

GOMAXPROCS_VAL := $(or $(GOMAXPROCS),$(DETECTED_PROCS))
PARALLEL_PROCS := $(shell if [ $(GOMAXPROCS_VAL) -gt 1 ]; then expr $(GOMAXPROCS_VAL) / 2; else echo 1; fi)


.PHONY: help
help: ## Display this help.
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make \033[36m<target>\033[0m\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)


.PHONY: install-go
install-go: ## Install Go dependencies and setup workspace
	@[ -f go.work ] || go work init . ./tools
	go mod download

.PHONY: install-brew-tools
install-brew-tools: ## Install Homebrew tools if they don't exist
	@command -v tilt >/dev/null 2>&1 || { echo "Installing tilt..."; brew install tilt; }
	@command -v ctlptl >/dev/null 2>&1 || { echo "Installing ctlptl..."; brew install ctlptl; }
	@command -v minikube >/dev/null 2>&1 || { echo "Installing minikube..."; brew install minikube; }

.PHONY: install
install: install-go ## Install all dependencies
	pnpm --dir=web install --frozen-lockfile



.PHONY: generate-sql
generate-sql: ## Generate SQL schema from Drizzle definitions
	@rm -f ./pkg/db/schema.sql || true
	@touch ./pkg/db/schema.sql
	@echo "-- Code generated by Makefile. DO NOT EDIT." >> ./pkg/db/schema.sql
	@echo "--" >> ./pkg/db/schema.sql
	@echo "-- Source: web/internal/db/src/schema" >> ./pkg/db/schema.sql
	@rm -rf ./web/internal/db/out
	@cd web/internal/db && pnpm drizzle-kit generate --schema=src/schema/index.ts --dialect=mysql --out=out --name=init --breakpoints=false
	@echo "\n" >> ./web/internal/db/out/0000_init.sql
	@cat ./web/internal/db/out/0000_init.sql >> ./pkg/db/schema.sql

	@rm -rf ./web/internal/db/out


.PHONY: nuke-docker
nuke-docker: ## Stop all containers and clean up Docker system
	docker stop $$(docker ps -aq)
	docker system prune -af
	docker volume prune --all -f



.PHONY: fmt
fmt: ## Format code and run linters
	go fmt ./...
	go tool buf format -w
	go tool golangci-lint run

	pnpm --dir=web fmt

.PHONY: pull
pull: ## Pull latest Docker images for services
	@docker compose -f ./dev/docker-compose.yaml pull

.PHONY: up
up: pull ## Start all infrastructure services
	@docker compose -f ./deployment/docker-compose.yaml up -d planetscale mysql redis clickhouse s3 otel kafka restate ctrl --wait

.PHONY: clean
clean: ## Stop and remove all services with volumes
	@docker compose -f ./dev/docker-compose.yaml down --volumes

.PHONY: build-go
build-go: ## Build go services
	go build -o bin/unkey .

.PHONY: build-web
build-web: ## Build web services
	pnpm --dir=web build

.PHONY: build
build: install build-go build-web ## Build all artifacts

.PHONY: generate
generate: generate-sql ## Generate code from protobuf and other sources
	rm -rf ./gen || true
	rm ./pkg/db/*_generated.go || true
	go generate ./...
	go fmt ./...
	pnpm --dir=web fmt

.PHONY: test-k8s
test-k8s: talos ## Run Kubernetes cluster tests
	go test ./apps/krane/pkg/k8s/test_cluster/... -v

.PHONY: test
test: test-unit ## Run unit tests (alias)
	pnpm --dir=web run test

.PHONY: test-unit
test-unit: up ## Run unit tests with infrastructure
	@echo "Running tests w/$(PARALLEL_PROCS) parallel test processes"
	@go test -json -failfast -timeout=15m -parallel=$(PARALLEL_PROCS) ./... | go run github.com/mfridman/tparse@ba2512e7be150bfcbd6f6220d517d3741f8f2f75 -all -smallscreen

.PHONY: test-stress
test-stress: export INTEGRATION_TEST=true
test-stress: export SIMULATION_TEST=false
test-stress: up ## Run stress tests
	@echo "Running stress tests w/$(PARALLEL_PROCS) parallel test processes"
	@go test -tags=stress,integration,integration_long -json -failfast -timeout=15m -parallel=$(PARALLEL_PROCS) ./... | go run github.com/mfridman/tparse@ba2512e7be150bfcbd6f6220d517d3741f8f2f75 -all -smallscreen

.PHONY: test-integration-long
test-integration-long: export INTEGRATION_TEST=true
test-integration-long: export SIMULATION_TEST=false
test-integration-long: up ## Run long integration tests
	@echo "Running long-ish integration tests w/$(PARALLEL_PROCS) parallel test processes"
	@go test -tags=integration,integration_long -json -failfast -timeout=15m -parallel=$(PARALLEL_PROCS) ./... | go run github.com/mfridman/tparse@ba2512e7be150bfcbd6f6220d517d3741f8f2f75 -all -smallscreen

.PHONY: test-integration
test-integration: export INTEGRATION_TEST=true
test-integration: export SIMULATION_TEST=false
test-integration: up ## Run integration tests
	@echo "Running integration tests w/$(PARALLEL_PROCS) parallel test processes"
	@go test -tags=integration -json -failfast -timeout=15m -parallel=$(PARALLEL_PROCS) ./... | go run github.com/mfridman/tparse@ba2512e7be150bfcbd6f6220d517d3741f8f2f75 -smallscreen


.PHONY: dev
dev: ## Start dev environment
	@# Make sure you have ./dev/.env.depot populated, or you will get some funny errors
	@# we're working on making this optional soon

	@ctlptl apply -f ./dev/cluster.yaml
	@minikube addons enable metrics-server
	@tilt up -f ./dev/Tiltfile

.PHONY: down
down: ## Stop dev environment
	@minikube delete

.PHONY: local-dashboard
local-dashboard: install build-go ## Run local development setup for dashboard
	pnpm --dir=web/apps/dashboard local
