name: PR Slack Notifications
on:
  pull_request:
    types: [opened, ready_for_review, closed, merged]
  pull_request_review:
    types: [submitted]

jobs:
  # Job 1: Handle PR lifecycle (create, close, merge)
  lifecycle:
    runs-on: ubuntu-latest
    if: (github.event.action == 'opened' || github.event.action == 'ready_for_review' || github.event.action == 'closed') && github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Post PR message to Slack
        if: github.event.action == 'opened' || github.event.action == 'ready_for_review'
        run: |
          curl -X POST -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
          -H "Content-type: application/json" \
          --data '{"channel":"${{ secrets.SLACK_CHANNEL }}","text":"${{env.SLACK_MESSAGE}}"}' \
          https://slack.com/api/chat.postMessage > output.json
          cat output.json
          cat output.json | jq -r '.ts' > slack-message-timestamp.txt
        env:
          SLACK_MESSAGE: "ðŸ“ *${{ github.event.pull_request.title }}* by ${{ github.event.pull_request.user.login }}\n${{ github.event.pull_request.html_url }}\n+${{ github.event.pull_request.additions }}/-${{ github.event.pull_request.deletions }} lines"
      - name: Cache message timestamp
        if: github.event.action == 'opened' || github.event.action == 'ready_for_review'
        uses: actions/cache/save@v3
        with:
          path: slack-message-timestamp.txt
          key: ${{ github.event.pull_request.html_url }}
      - name: Handle PR closure
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Restore timestamp
            const cacheKey = `${{ github.event.pull_request.html_url }}`;
            console.log('Looking for cache key:', cacheKey);
            
            // Try to restore cache
            const cacheResponse = await fetch(`https://api.github.com/repos/${context.repo.owner}/${context.repo.repo}/actions/cache/keys`, {
              headers: {
                'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            // For now, we'll use a different approach - restore from cache action
            console.log('PR closed - merged:', github.event.pull_request.merged);
            
            let reactions = [];
            if (github.event.pull_request.merged) {
              reactions.push('merged', 'party_parrot');
            } else {
              reactions.push('x');
            }
            
            console.log('Closure reactions:', reactions);
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}

  # Job 2: Handle CI status
  ci:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'ready_for_review' || github.event.action == 'synchronize') && github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Wait for CI to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'test_packages'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
      - name: Restore message timestamp
        uses: actions/cache/restore@v3
        with:
          path: slack-message-timestamp.txt
          key: ${{ github.event.pull_request.html_url }}
      - name: Add CI status reaction
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('slack-message-timestamp.txt')) {
              console.log('ERROR: slack-message-timestamp.txt not found!');
              return;
            }
            
            const timestamp = fs.readFileSync('slack-message-timestamp.txt', 'utf8').trim();
            console.log('Timestamp:', timestamp);
            
            // Get CI status
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: github.event.pull_request.head.sha,
            });
            
            const allChecks = checks.check_runs;
            const completedChecks = allChecks.filter(check => check.status === 'completed');
            const failedChecks = completedChecks.filter(check => check.conclusion !== 'success');
            
            let reaction = '';
            if (completedChecks.length === 0) {
              reaction = 'hourglass_flowing_sand';
            } else if (failedChecks.length === 0) {
              reaction = 'white_check_mark';
            } else {
              reaction = 'x';
            }
            
            console.log('CI reaction:', reaction);
            
            // Add reaction to message
            const response = await fetch('https://slack.com/api/reactions.add', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.SLACK_BOT_TOKEN}`,
                'Content-type': 'application/json',
              },
              body: JSON.stringify({
                channel: process.env.SLACK_CHANNEL,
                timestamp: timestamp,
                name: reaction
              })
            });
            
            const result = await response.json();
            console.log('Reaction result:', result);
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}

  # Job 3: Handle approvals
  approvals:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved' && github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Restore message timestamp
        uses: actions/cache/restore@v3
        with:
          path: slack-message-timestamp.txt
          key: ${{ github.event.pull_request.html_url }}
      - name: Add approval reaction
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('slack-message-timestamp.txt')) {
              console.log('ERROR: slack-message-timestamp.txt not found!');
              return;
            }
            
            const timestamp = fs.readFileSync('slack-message-timestamp.txt', 'utf8').trim();
            console.log('Timestamp:', timestamp);
            console.log('Review state:', github.event.review.state);
            
            // Get approval count
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const approvals = reviews.filter(review => review.state === 'approved');
            const approvalCount = approvals.length;
            
            console.log('Total approvals:', approvalCount);
            
            let reaction = '';
            if (approvalCount === 0) {
              reaction = 'eyes';
            } else if (approvalCount === 1) {
              reaction = 'thumbsup';
            } else if (approvalCount >= 2) {
              reaction = 'white_check_mark';
            }
            
            console.log('Approval reaction:', reaction);
            
            // Add reaction to message
            const response = await fetch('https://slack.com/api/reactions.add', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.SLACK_BOT_TOKEN}`,
                'Content-type': 'application/json',
              },
              body: JSON.stringify({
                channel: process.env.SLACK_CHANNEL,
                timestamp: timestamp,
                name: reaction
              })
            });
            
            const result = await response.json();
            console.log('Reaction result:', result);
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}