name: PR
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
  merge_group:
    branches: [main]
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.sha }}
  cancel-in-progress: true
permissions:
  contents: read
jobs:
  detect_changes:
    if: (github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name != 'pull_request'
    uses: ./.github/workflows/job_detect_changes.yaml
  test_packages:
    name: Test Packages
    if: ((github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name != 'pull_request') && needs.detect_changes.result == 'success' && (needs.detect_changes.outputs.packages == 'true' || needs.detect_changes.outputs.dependencies == 'true')
    needs: [detect_changes]
    uses: ./.github/workflows/job_test_web.yaml
  test_api:
    name: Test API
    if: ((github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name != 'pull_request') && needs.detect_changes.result == 'success' && (needs.detect_changes.outputs.api == 'true' || needs.detect_changes.outputs.packages == 'true' || needs.detect_changes.outputs.go == 'true')
    needs: [detect_changes]
    uses: ./.github/workflows/job_test_api_local.yaml
  lint_go:
    name: Lint Go Code
    if: ((github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name != 'pull_request') && needs.detect_changes.result == 'success' && needs.detect_changes.outputs.go == 'true'
    needs: [detect_changes]
    uses: ./.github/workflows/job_lint_go.yaml
  bazel:
    name: Bazel
    if: ((github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name != 'pull_request') && needs.detect_changes.result == 'success' && needs.detect_changes.outputs.go == 'true'
    needs: [detect_changes]
    uses: ./.github/workflows/job_bazel.yaml
    secrets: inherit
  # This job ensures branch protection passes even when Bazel is skipped
  bazel_status:
    name: Bazel Status Check
    if: always() && ((github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name != 'pull_request')
    needs: [detect_changes, bazel]
    runs-on: ubuntu-latest
    steps:
      - name: Check Bazel Status
        run: |
          if [[ "${{ needs.detect_changes.outputs.go }}" != "true" ]]; then
            echo "Bazel skipped - no Go changes detected"
            exit 0
          elif [[ "${{ needs.bazel.result }}" == "success" ]]; then
            echo "Bazel passed"
            exit 0
          elif [[ "${{ needs.bazel.result }}" == "skipped" ]]; then
            echo "Bazel skipped"
            exit 0
          else
            echo "Bazel failed"
            exit 1
          fi
  test_dashboard:
    name: Test Dashboard
    if: ((github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name != 'pull_request') && needs.detect_changes.result == 'success' && needs.detect_changes.outputs.dashboard == 'true'
    needs: [detect_changes]
    uses: ./.github/workflows/job_test_dashboard.yaml
  validate_workflows:
    name: Validate Workflows
    if: ((github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name != 'pull_request') && needs.detect_changes.result == 'success' && needs.detect_changes.outputs.workflows == 'true'
    needs: [detect_changes]
    uses: ./.github/workflows/job_validate_workflows.yaml
