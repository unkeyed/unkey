name: Restate Scheduled Tasks
permissions:
  contents: read

on:
  schedule:
    - cron: "0 15 * * *" # Quota check: Daily at 15:00 UTC
    - cron: "0 3 * * *" # Cert renewal: Daily at 03:00 UTC
    - cron: "0 0 * * *" # Key refill: Daily at 00:00 UTC
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - quota-check
          - cert-renewal
          - key-refill

jobs:
  quota-check:
    if: github.event.schedule == '0 15 * * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'quota-check'
    environment: operations
    runs-on: ubuntu-latest
    steps:
      - name: Calculate billing period
        id: billing
        run: echo "period=$(date -u +'%Y-%m')" >> $GITHUB_OUTPUT

      - name: Invoke Restate Quota Check
        env:
          RESTATE_URL: ${{ secrets.RESTATE_URL }}
          RESTATE_API_KEY: ${{ secrets.RESTATE_API_KEY }}
        run: |
          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${RESTATE_API_KEY}" \
            -H "idempotency-key: quota-check-$(date -u +'%Y-%m-%d')" \
            "${RESTATE_URL}/hydra.v1.QuotaCheckService/${{ steps.billing.outputs.period }}/RunCheck/send" \
            -d '{}'

  certificate-renewal:
    if: github.event.schedule == '0 3 * * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'cert-renewal'
    environment: operations
    runs-on: ubuntu-latest
    steps:
      - name: Invoke Restate Certificate Renewal
        env:
          RESTATE_URL: ${{ secrets.RESTATE_URL }}
          RESTATE_API_KEY: ${{ secrets.RESTATE_API_KEY }}
        run: |
          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${RESTATE_API_KEY}" \
            -H "idempotency-key: cert-renewal-$(date -u +'%Y-%m-%d')" \
            "${RESTATE_URL}/hydra.v1.CertificateService/global/RenewExpiringCertificates/send" \
            -d '{"daysBeforeExpiry": 30}'

  key-refill:
    if: github.event.schedule == '0 0 * * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'key-refill'
    environment: operations
    runs-on: ubuntu-latest
    steps:
      - name: Calculate date
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Invoke Restate Key Refill
        env:
          RESTATE_URL: ${{ secrets.RESTATE_URL }}
          RESTATE_API_KEY: ${{ secrets.RESTATE_API_KEY }}
        run: |
          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${RESTATE_API_KEY}" \
            -H "idempotency-key: key-refill-${{ steps.date.outputs.date }}" \
            "${RESTATE_URL}/hydra.v1.KeyRefillService/${{ steps.date.outputs.date }}/RunRefill/send" \
            -d '{}'
