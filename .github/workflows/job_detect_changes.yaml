name: Detect Changes
on:
  workflow_call:
    outputs:
      api:
        description: "Whether API has changed"
        value: ${{ jobs.build.outputs.api }}
      dashboard:
        description: "Whether Dashboard has changed"
        value: ${{ jobs.build.outputs.dashboard }}
      go:
        description: "Whether Go services have changed"
        value: ${{ jobs.build.outputs.go }}
      clickhouse:
        description: "Whether ClickHouse schema has changed"
        value: ${{ jobs.build.outputs.clickhouse }}
      docs:
        description: "Whether docs have changed"
        value: ${{ jobs.build.outputs.docs }}
      workflows:
        description: "Whether workflows have changed"
        value: ${{ jobs.build.outputs.workflows }}
      dependencies:
        description: "Whether dependencies have changed"
        value: ${{ jobs.build.outputs.dependencies }}
      packages:
        description: "Whether internal packages have changed"
        value: ${{ jobs.build.outputs.packages }}
      configs:
        description: "Whether config files have changed"
        value: ${{ jobs.build.outputs.configs }}
permissions:
  contents: read
jobs:
  build:
    name: Detect Changes
    runs-on: depot-ubuntu-24.04-4
    outputs:
      api: ${{ steps.changes.outputs.api }}
      dashboard: ${{ steps.changes.outputs.dashboard }}
      go: ${{ steps.changes.outputs.go }}
      clickhouse: ${{ steps.changes.outputs.clickhouse }}
      docs: ${{ steps.changes.outputs.docs }}
      workflows: ${{ steps.changes.outputs.workflows }}
      dependencies: ${{ steps.changes.outputs.dependencies }}
      packages: ${{ steps.changes.outputs.packages }}
      configs: ${{ steps.changes.outputs.configs }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            # API application and its direct dependencies
            api:
              - 'web/apps/api/**'
              - 'web/internal/clickhouse/**'
              - 'web/internal/db/**'
              - 'web/internal/encoding/**'
              - 'web/internal/encryption/**'
              - 'web/internal/error/**'
              - 'web/internal/hash/**'
              - 'web/internal/id/**'
              - 'web/internal/keys/**'
              - 'web/internal/logs/**'
              - 'web/internal/metrics/**'
              - 'web/internal/rbac/**'
              - 'web/internal/schema/**'
              - 'web/internal/validation/**'
              - 'web/internal/vault/**'
              - 'web/internal/worker-logging/**'

            # Dashboard application and its dependencies
            dashboard:
              - 'web/apps/dashboard/**/!(*.md|*.txt)'
              - 'web/apps/dashboard/!(*.md|*.txt)'
              - 'web/internal/billing/**'
              - 'web/internal/clickhouse/**'
              - 'web/internal/db/**'
              - 'web/internal/encryption/**'
              - 'web/internal/error/**'
              - 'web/internal/events/**'
              - 'web/internal/hash/**'
              - 'web/internal/icons/**'
              - 'web/internal/id/**'
              - 'web/internal/keys/**'
              - 'web/internal/rbac/**'
              - 'web/internal/resend/**'
              - 'web/internal/schema/**'
              - 'web/internal/ui/**'
              - 'web/internal/validation/**'
              - 'web/internal/vercel/**'
              - 'web/packages/error/**'
              - 'web/packages/rbac/**'


            # Go services (API v2, Ctrl, Deploy services)
            go:
              - 'cmd/**'
              - 'svc/**'
              - 'pkg/**'
              - 'internal/**'
              - 'proto/**'
              - 'gen/**'
              - 'demo_api/**'
              - 'test-docker/**'
              - 'go.mod'
              - 'go.sum'
              - '*.go'
              - 'tools/**'
              - 'web/apps/agent/**'

            # ClickHouse schema and related
            clickhouse:
              - 'pkg/clickhouse/**'
              - 'web/internal/clickhouse/**'
              - 'web/apps/agent/pkg/clickhouse/**'
              - 'dev/config/clickhouse/**'

            # Documentation (apps/docs only - .md files ARE content)
            docs:
              - 'web/apps/docs/**'

            # GitHub workflows and CI/CD
            workflows:
              - '.github/**'

            # Dependency changes
            dependencies:
              - 'web/pnpm-lock.yaml'
              - 'go.sum'
              - 'go.mod'
              - '**/package.json'
              - '**/go.mod'
              - '**/go.sum'

            # Internal packages (affect multiple apps)
            packages:
              - 'web/internal/clickhouse/**'
              - 'web/internal/db/**'
              - 'web/internal/encryption/**'
              - 'web/internal/error/**'
              - 'web/internal/hash/**'
              - 'web/internal/id/**'
              - 'web/internal/keys/**'
              - 'web/internal/rbac/**'
              - 'web/internal/schema/**'
              - 'web/internal/validation/**'
              - 'web/packages/**'

            # Configuration files
            configs:
              - '*.json'
              - '*.yaml'
              - '*.yml'
              - '*.toml'
              - '*.config.*'
              - 'Dockerfile*'
              - 'docker-compose*'
              - 'dev/**'
              - 'biome.json'
              - 'turbo.json'
              - 'vitest.workspace.json'
