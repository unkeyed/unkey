name: Detect Changes
on:
  workflow_call:
    outputs:
      api:
        description: "Whether API has changed"
        value: ${{ jobs.build.outputs.api }}
      dashboard:
        description: "Whether Dashboard has changed"
        value: ${{ jobs.build.outputs.dashboard }}
      agent:
        description: "Whether Agent has changed"
        value: ${{ jobs.build.outputs.agent }}
      logdrain:
        description: "Whether Logdrain has changed"
        value: ${{ jobs.build.outputs.logdrain }}
      go:
        description: "Whether Go services have changed"
        value: ${{ jobs.build.outputs.go }}
      clickhouse:
        description: "Whether ClickHouse schema has changed"
        value: ${{ jobs.build.outputs.clickhouse }}
      docs:
        description: "Whether docs have changed"
        value: ${{ jobs.build.outputs.docs }}
      workflows:
        description: "Whether workflows have changed"
        value: ${{ jobs.build.outputs.workflows }}
      dependencies:
        description: "Whether dependencies have changed"
        value: ${{ jobs.build.outputs.dependencies }}
      packages:
        description: "Whether internal packages have changed"
        value: ${{ jobs.build.outputs.packages }}
      configs:
        description: "Whether config files have changed"
        value: ${{ jobs.build.outputs.configs }}
permissions:
  contents: read
jobs:
  build:
    name: Detect Changes
    runs-on: depot-ubuntu-24.04-4
    outputs:
      api: ${{ steps.changes.outputs.api }}
      dashboard: ${{ steps.changes.outputs.dashboard }}
      agent: ${{ steps.changes.outputs.agent }}
      logdrain: ${{ steps.changes.outputs.logdrain }}
      go: ${{ steps.changes.outputs.go }}
      clickhouse: ${{ steps.changes.outputs.clickhouse }}
      docs: ${{ steps.changes.outputs.docs }}
      workflows: ${{ steps.changes.outputs.workflows }}
      dependencies: ${{ steps.changes.outputs.dependencies }}
      packages: ${{ steps.changes.outputs.packages }}
      configs: ${{ steps.changes.outputs.configs }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            # API application and its direct dependencies
            api:
              - 'apps/api/**'
              - 'go/**'
              - 'internal/db/**'
              - 'internal/encoding/**'
              - 'internal/encryption/**'
              - 'internal/hash/**'
              - 'internal/id/**'
              - 'internal/keys/**'
              - 'internal/validation/**'
              - 'internal/vault/**'

            # Dashboard application and its dependencies
            dashboard:
              - 'apps/dashboard/**/!(*.md|*.txt)'
              - 'apps/dashboard/!(*.md|*.txt)'
              - 'internal/billing/**'
              - 'internal/clickhouse/**'
              - 'internal/db/**'
              - 'internal/encryption/**'
              - 'internal/events/**'
              - 'internal/hash/**'
              - 'internal/icons/**'
              - 'internal/id/**'
              - 'internal/keys/**'
              - 'internal/resend/**'
              - 'internal/schema/**'
              - 'internal/ui/**'
              - 'internal/validation/**'
              - 'internal/vercel/**'
              - 'packages/error/**'
              - 'packages/rbac/**'

            # Agent application (Go-based)
            agent:
              - 'apps/agent/**'

            # Logdrain application
            logdrain:
              - 'apps/logdrain/**/!(*.md|*.txt)'
              - 'apps/logdrain/!(*.md|*.txt)'

            # Go services (API v2, Ctrl, Deploy services)
            go:
              - 'go/!(benchmarks|demo_api)/**'
              - 'go/!(benchmarks|demo_api)'

            # ClickHouse schema and related
            clickhouse:
              - 'internal/clickhouse/**'
              - 'go/internal/clickhouse/**'

            # Documentation (apps/docs only - .md files ARE content)
            docs:
              - 'apps/docs/**'

            # GitHub workflows and CI/CD
            workflows:
              - '.github/**'

            # Dependency changes
            dependencies:
              - 'pnpm-lock.yaml'
              - 'go.sum'
              - 'go.mod'
              - '**/package.json'
              - '**/go.mod'
              - '**/go.sum'

            # Internal packages (affect multiple apps)
            packages:
              - 'internal/**'
              - 'packages/**'

            # Configuration files
            configs:
              - '*.json'
              - '*.yaml'
              - '*.yml'
              - '*.toml'
              - '*.config.*'
              - 'Dockerfile*'
              - 'docker-compose*'
              - 'deployment/**'
              - 'biome.json'
              - 'turbo.json'
              - 'vitest.workspace.json'
