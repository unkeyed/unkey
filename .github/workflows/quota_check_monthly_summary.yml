name: Monthly Quota Summary
permissions:
  contents: read

on:
  schedule:
    - cron: "0 23 28-31 * *" # Last days of month at 23:00 UTC
  workflow_dispatch:

jobs:
  check-last-day:
    runs-on: ubuntu-latest
    outputs:
      is-last-day: ${{ steps.check.outputs.is-last-day }}
    steps:
      - name: Check if last day of month
        id: check
        run: |
          tomorrow=$(date -u -d "tomorrow" +'%d')
          [ "$tomorrow" = "01" ] && echo "is-last-day=true" >> $GITHUB_OUTPUT || echo "is-last-day=false" >> $GITHUB_OUTPUT

  monthly-summary:
    needs: check-last-day
    if: needs.check-last-day.outputs.is-last-day == 'true' || github.event_name == 'workflow_dispatch'
    environment: operations
    runs-on: ubuntu-latest
    steps:
      - name: Calculate billing period
        id: billing
        run: echo "period=$(date -u +'%Y-%m')" >> $GITHUB_OUTPUT

      - name: Invoke Restate Monthly Summary
        env:
          RESTATE_URL: ${{ secrets.RESTATE_URL }}
          RESTATE_API_KEY: ${{ secrets.RESTATE_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${RESTATE_API_KEY}" \
            "${RESTATE_URL}/hydra.v1.QuotaCheckService/${{ steps.billing.outputs.period }}/SendMonthlySummary" \
            -d '{"slackWebhookUrl": "'"${SLACK_WEBHOOK_URL}"'"}'
