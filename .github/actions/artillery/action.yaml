name: Artillery
description: Run artillery tests

inputs:
  target:
    description: 'The target URL to test'
    required: true
    default: 'https://api.unkey.dev'
  region:
    description: 'The aws region to test from'
    required: true
  keys:
    description: 'The keys to test as a csv string'
    required: true
  artilleryCloudKey:
    description: 'The artillery cloud key'
    required: true
    
    

runs:
  using: "composite"
  

  steps:
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Prepare
      shell: bash
      run: |
        cat <<EOF > .keys.csv
         ${{ inputs.keys }}
         EOF
      working-directory: tools/artillery

    - name: Run
      shell: bash
      run: npx artillery@latest run-lambda --record --key=${{ inputs.artilleryCloudKey }} --region ${{ inputs.region }} --count=10 --target=${{inputs.target}}  ./keys.verifyKey.yaml 
      working-directory: tools/artillery
