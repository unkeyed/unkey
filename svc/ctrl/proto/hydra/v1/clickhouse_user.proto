syntax = "proto3";

package hydra.v1;

import "dev/restate/sdk/go.proto";

option go_package = "github.com/unkeyed/unkey/gen/proto/hydra/v1;hydrav1";

// ClickhouseUserService manages ClickHouse user provisioning for workspaces.
//
// This service creates and configures ClickHouse users with appropriate
// permissions, quotas, and row-level security policies for analytics access.
// It uses the vault API for password encryption and stores credentials in MySQL.
service ClickhouseUserService {
  option (dev.restate.sdk.go.service_type) = VIRTUAL_OBJECT;

  // ConfigureUser creates or updates a ClickHouse user for a workspace.
  //
  // Key: workspace_id (prevents concurrent user provisioning for the same workspace)
  //
  // For new users:
  // - Generates a secure password
  // - Encrypts password via vault API
  // - Stores credentials in MySQL
  // - Creates ClickHouse user with permissions, quotas, and row policies
  //
  // For existing users:
  // - Preserves the existing password
  // - Updates quotas and settings as specified
  // - Reapplies ClickHouse permissions and row policies
  rpc ConfigureUser(ConfigureUserRequest) returns (ConfigureUserResponse) {}
}

message ConfigureUserRequest {
  // workspace_id is also the Restate object key and the ClickHouse username
  string workspace_id = 1;

  // Optional quota overrides - if not set, uses defaults from service
  optional int32 quota_duration_seconds = 2;       // default: 3600 (1 hour)
  optional int32 max_queries_per_window = 3;       // default: 1000
  optional int32 max_execution_time_per_window = 4; // default: 1800 (30 min)
  optional int32 max_query_execution_time = 5;     // default: 30 (seconds)
  optional int64 max_query_memory_bytes = 6;       // default: 1000000000 (1GB)
  optional int32 max_query_result_rows = 7;        // default: 10000000
}

message ConfigureUserResponse {
  // Empty on success. Errors are returned via the RPC error mechanism.
}
