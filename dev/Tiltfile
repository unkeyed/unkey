load('ext://namespace', 'namespace_create')
load('ext://restart_process',  'docker_build_with_restart')
load('ext://secret', 'secret_create_generic')

cfg = config.parse()

update_settings(suppress_unused_image_warnings=["unkey/sentinel:latest"])

# Check which optional credential files exist
has_depot_credentials = os.path.exists('./.env.depot')
has_github_credentials = os.path.exists('./.env.github') and os.path.exists('./.github-private-key.pem')

local_resource(
  'namespace',
  'kubectl apply -f k8s/manifests/namespace.yaml',
  labels=['setup'],
)

local_resource(
  'sentinel',
  'kubectl apply -f k8s/manifests/sentinel.yaml',
  labels=['setup'],
)

local_resource(
  'rbac',
  'kubectl apply -f k8s/manifests/rbac.yaml',
  labels=['setup'],
)

local_resource(
  'registry',
  '''
  REGISTRY_IP=$(docker inspect ctlptl-registry --format '{{range .NetworkSettings.Networks}}{{.IPAddress}} {{end}}' | awk '{print $NF}')
  echo "Registry IP: $REGISTRY_IP"
  cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: ctlptl-registry
  namespace: unkey
spec:
  ports:
    - port: 5000
      targetPort: 5000
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: ctlptl-registry
  namespace: unkey
  labels:
    kubernetes.io/service-name: ctlptl-registry
addressType: IPv4
endpoints:
  - addresses:
      - "$REGISTRY_IP"
ports:
  - port: 5000
EOF
  ''',
  resource_deps=['namespace'],
  labels=['setup'],
)

local_resource(
  'cilium-policies',
  'kubectl apply -f k8s/manifests/cilium-policies.yaml',
  labels=['setup'],
)

local_resource(
  'hubble',
  'kubectl -n kube-system patch configmap cilium-config --type merge -p \'{"data":{"enable-hubble":"true","hubble-listen-address":":4244"}}\' && kubectl -n kube-system rollout restart daemonset cilium && kubectl apply -f k8s/manifests/hubble.yaml && kubectl -n kube-system rollout status daemonset cilium --timeout=120s',
  resource_deps=['cilium-policies'],
  labels=['observability'],
)

local_resource(
  'hubble-ui',
  serve_cmd='while true; do kubectl wait --for=condition=ready pod -l k8s-app=hubble-ui -n kube-system --timeout=120s && kubectl port-forward -n kube-system svc/hubble-ui 12000:80; echo "port-forward exited, retrying in 5s..."; sleep 5; done',
  resource_deps=['hubble'],
  labels=['observability'],
  links=['http://localhost:12000'],
)

local_resource(
    'depot-credentials',
    'if [ -f ./.env.depot ]; then kubectl -n unkey create secret generic depot-credentials --from-env-file=./.env.depot -o yaml --dry-run=client | kubectl apply -f -; else echo "Skipping depot-credentials (no .env.depot file)"; fi',
    resource_deps=['namespace'],
    deps=['./.env.depot'],
    labels=['setup'],
    allow_parallel=True,
)

local_resource(
    'github-credentials',
    '''if [ -f ./.env.github ] && [ -f ./.github-private-key.pem ]; then set -a && source ./.env.github && set +a && kubectl -n unkey create secret generic github-credentials \
      --from-literal=UNKEY_GITHUB_APP_ID="$UNKEY_GITHUB_APP_ID" \
      --from-literal=UNKEY_GITHUB_APP_WEBHOOK_SECRET="$UNKEY_GITHUB_APP_WEBHOOK_SECRET" \
      --from-literal=NEXT_PUBLIC_GITHUB_APP_NAME="$NEXT_PUBLIC_GITHUB_APP_NAME" \
      --from-literal=UNKEY_ALLOW_UNAUTHENTICATED_DEPLOYMENTS="$UNKEY_ALLOW_UNAUTHENTICATED_DEPLOYMENTS" \
      --from-file=UNKEY_GITHUB_PRIVATE_KEY_PEM=./.github-private-key.pem \
      -o yaml --dry-run=client | kubectl apply -f -; else echo "Skipping github-credentials (missing .env.github or .github-private-key.pem)"; fi''',
    resource_deps=['namespace'],
    deps=['./.env.github', './.github-private-key.pem'],
    labels=['setup'],
    allow_parallel=True,
)

local_resource(
    'webhooks-config',
    'if [ -f ./.env.webhooks ]; then kubectl -n unkey create configmap ctrl-worker-webhooks --from-env-file=./.env.webhooks -o yaml --dry-run=client | kubectl apply -f -; else kubectl -n unkey delete configmap ctrl-worker-webhooks --ignore-not-found; fi',
    resource_deps=['namespace'],
    deps=['./.env.webhooks'],
    labels=['setup'],
    allow_parallel=True,
)

# Frontline TLS certificates - generates certs with mkcert if they don't exist
local_resource(
    'frontline-certs',
    'if [ ! -f ./certs/unkey.local.crt ]; then echo "Generating TLS certificates..." && command -v mkcert >/dev/null || { echo "ERROR: mkcert not found. Install with: brew install mkcert"; exit 1; } && mkcert -install && mkdir -p ./certs && mkcert -cert-file ./certs/unkey.local.crt -key-file ./certs/unkey.local.key "*.unkey.local" "unkey.local" "localhost" && echo "*.crt" > ./certs/.gitignore && echo "*.key" >> ./certs/.gitignore; fi && kubectl -n unkey create configmap frontline-certs --from-file=./certs/unkey.local.crt --from-file=./certs/unkey.local.key -o yaml --dry-run=client | kubectl apply -f -',
    resource_deps=['namespace'],
    labels=['setup'],
)

# Redis service
k8s_yaml('k8s/manifests/redis.yaml')
k8s_resource('redis', port_forwards='6379:6379', resource_deps=[], labels=['database'])

# MySQL service
docker_build('unkey/mysql:local', '..', dockerfile='./Dockerfile.mysql')
k8s_yaml('k8s/manifests/mysql.yaml')
k8s_resource('mysql', port_forwards='3306:3306', resource_deps=[], labels=['database'])

# ClickHouse service
docker_build('unkey/clickhouse:local', '..', dockerfile='./Dockerfile.clickhouse')
k8s_yaml('k8s/manifests/clickhouse.yaml')
k8s_resource('clickhouse', port_forwards=['8123:8123','9000:9000'], resource_deps=[], labels=['database'])

# Vector Logs (collects logs from krane-managed deployments -> ClickHouse)
k8s_yaml('k8s/manifests/vector-logs.yaml')
k8s_resource('vector-logs', resource_deps=['clickhouse', 'rbac'], labels=['observability'])

# S3 (MinIO) service
k8s_yaml('k8s/manifests/s3.yaml')
k8s_resource('s3', port_forwards=['3902:3902', '3903:3903'], resource_deps=[], labels=['database'])

# PlanetScale HTTP driver
k8s_yaml('k8s/manifests/planetscale.yaml')
k8s_resource(
    'planetscale',
    port_forwards='3900:3900',
    resource_deps=['mysql'],
    labels=['database']
)

# Restate service
k8s_yaml('k8s/manifests/restate.yaml')
k8s_resource('restate', port_forwards=['8080:8080', '9070:9070'], resource_deps=[], labels=['database'])


# Build Go binaries locally (auto-detect arch from minikube)
local_resource(
    'build-unkey',
    'cd .. && CGO_ENABLED=0 GOOS=linux GOARCH=$(minikube ssh -- uname -m | sed "s/x86_64/amd64/" | sed "s/aarch64/arm64/" | tr -d "\\r") go build -o bin/unkey .',
    deps=['../main.go', '../pkg', '../cmd', '../svc', '../gen'],
    labels=['build'],
)


# Single docker image for all Go services - k8s manifests use `args` to specify which service to run
docker_build_with_restart(
    'unkey/go:latest',
    '..',
    dockerfile='./Dockerfile.tilt',
    entrypoint=['/unkey'],
    only=['./bin'],
    live_update=[sync('./bin/unkey', '/unkey')]
)



# Vault service
k8s_yaml('k8s/manifests/vault.yaml')
k8s_resource(
  'vault',
  port_forwards='8060:8060',
  resource_deps=['s3', 'build-unkey'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# API service
k8s_yaml('k8s/manifests/api.yaml')
k8s_resource(
  'api',
  port_forwards='7070:7070',
  resource_deps=['mysql', 'clickhouse', 'redis', 'build-unkey'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# Ctrl service
k8s_yaml('k8s/manifests/ctrl-api.yaml')
ctrl_api_deps = ['mysql', 'clickhouse', 'restate', 'vault', 'build-unkey', 'github-credentials']
if has_depot_credentials:
    ctrl_api_deps.append('depot-credentials')
k8s_resource(
  'ctrl-api',
  port_forwards='7091:7091',
  resource_deps=ctrl_api_deps,
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# Worker service (Restate workflow handlers)
k8s_yaml('k8s/manifests/ctrl-worker.yaml')
ctrl_worker_deps = ['mysql', 'clickhouse', 'restate', 'build-unkey', 'webhooks-config', 'github-credentials']
if has_depot_credentials:
    ctrl_worker_deps.append('depot-credentials')
k8s_resource(
  'ctrl-worker',
  port_forwards=['7092:7092'],
  resource_deps=ctrl_worker_deps,
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# Frontline service (TLS termination proxy for *.unkey.local)
k8s_yaml('k8s/manifests/frontline.yaml')
k8s_resource(
  'frontline',
  port_forwards=['9443:7443', '9080:7070'],
  resource_deps=['mysql', 'ctrl-api', 'vault', 'build-unkey', 'frontline-certs'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO,
  links=['https://app.unkey.local'],
)

# Krane service
k8s_yaml('k8s/manifests/krane.yaml')
k8s_resource(
  'krane',
  port_forwards='8070:8070',
  resource_deps=['ctrl-api', 'build-unkey', 'rbac', 'namespace', 'sentinel', 'cilium-policies', 'build-sentinel-image'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)




# Preflight (mutating admission controller for secrets and credentials injection)

# Build inject binary and image (auto-detect arch from minikube)
local_resource(
    'build-inject',
    'cd .. && CGO_ENABLED=0 GOOS=linux GOARCH=$(minikube ssh -- uname -m | sed "s/x86_64/amd64/" | sed "s/aarch64/arm64/" | tr -d "\\r") go build -o bin/inject ./cmd/inject && docker build -t inject:latest -f dev/Dockerfile.inject . && minikube image load inject:latest',
    deps=['../cmd/inject', '../pkg/secrets', '../pkg/cli'],
    allow_parallel=True,
    labels=['build'],
)

k8s_yaml('k8s/manifests/preflight.yaml')
preflight_deps = ['build-unkey', 'build-inject']
if has_depot_credentials:
    preflight_deps.append('depot-credentials')
k8s_resource(
  'preflight',
  port_forwards='8090:8080',
  resource_deps=preflight_deps,
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# Sentinel image (same Go binary, used by ctrl to spawn sentinels)
# Build locally and load into minikube
local_resource(
    'build-sentinel-image',
    'docker build -t unkey/sentinel:latest -f Dockerfile.tilt .. && minikube image load unkey/sentinel:latest',
    deps=['../bin'],
    resource_deps=['build-unkey'],
    labels=['build'],
)



# Dashboard - runs locally with HMR
# Injects GitHub App env vars from dev/.env.github and dev/.github-private-key.pem
local_resource(
    'dashboard',
    serve_cmd='''
      set -a
      [ -f ./.env.github ] && source ./.env.github
      [ -f ./.github-private-key.pem ] && export UNKEY_GITHUB_PRIVATE_KEY_PEM="$(cat ./.github-private-key.pem)"
      export GITHUB_APP_ID="$UNKEY_GITHUB_APP_ID"
      set +a
      cd ../web && pnpm --filter=@unkey/dashboard dev
    ''',
    deps=[],
    resource_deps=['planetscale', 'clickhouse', 'ctrl-api'],
    labels=['unkey'],
    auto_init=True,
    readiness_probe=probe(http_get=http_get_action(port=3000, path='/'), period_secs=5, failure_threshold=30),
    links=['http://localhost:3000'],
)

print("""
Tilt is ready!


Web UI: http://localhost:10350

Tips:
- Press 's' to open a shell in running containers
- Press 'r' to manually trigger rebuilds
- Use 'tilt down' to stop all services
- Use 'tilt logs <service>' to view specific service logs

Frontline (HTTPS on *.unkey.local):
- Run 'sudo minikube tunnel' in a separate terminal to bind ports 80/443
- Then access https://app.unkey.local (requires DNS setup via setup-wildcard-dns.sh)

""")
