load('ext://namespace', 'namespace_create')
load('ext://restart_process',  'docker_build_with_restart')
load('ext://secret', 'secret_create_generic')

cfg = config.parse()

update_settings(suppress_unused_image_warnings=["unkey/sentinel:latest"])

local_resource(
  'namespace',
  'kubectl apply -f k8s/manifests/namespace.yaml',
  labels=['setup'],
)


local_resource(
  'rbac',
  'kubectl apply -f k8s/manifests/rbac.yaml',
  labels=['setup'],
)

local_resource(
    'depot-credentials',
    'kubectl -n unkey create secret generic depot-credentials --from-env-file=./.env.depot -o yaml --dry-run=client | kubectl apply -f -',
    resource_deps=['namespace'],
    deps=['./.env.depot'],
    labels=['setup'],
)


# Redis service
k8s_yaml('k8s/manifests/redis.yaml')
k8s_resource('redis', port_forwards='6379:6379', resource_deps=['namespace'], labels=['database'])

# MySQL service
docker_build('unkey/mysql:local', '..', dockerfile='./Dockerfile.mysql')
k8s_yaml('k8s/manifests/mysql.yaml')
k8s_resource('mysql', port_forwards='3306:3306', resource_deps=['namespace'], labels=['database'])

# ClickHouse service
docker_build('unkey/clickhouse:local', '..', dockerfile='./Dockerfile.clickhouse')
k8s_yaml('k8s/manifests/clickhouse.yaml')
k8s_resource('clickhouse', port_forwards='8123:8123', resource_deps=['namespace'], labels=['database'])

# S3 (MinIO) service
k8s_yaml('k8s/manifests/s3.yaml')
k8s_resource('s3', port_forwards=['3902:3902', '3903:3903'], resource_deps=['namespace'], labels=['database'])

# PlanetScale HTTP driver
k8s_yaml('k8s/manifests/planetscale.yaml')
k8s_resource(
    'planetscale',
    resource_deps=['namespace', 'mysql'],
    labels=['database']
)

# Restate service
k8s_yaml('k8s/manifests/restate.yaml')
k8s_resource('restate', port_forwards=['8081:8080', '9070:9070'], resource_deps=['namespace'], labels=['database'])


# Build Go binaries locally (auto-detect arch from minikube)
local_resource(
    'build-unkey',
    'cd .. && CGO_ENABLED=0 GOOS=linux GOARCH=$(minikube ssh -- uname -m | sed "s/x86_64/amd64/" | sed "s/aarch64/arm64/" | tr -d "\\r") go build -o bin/unkey .',
    deps=['../main.go', '../pkg', '../cmd', '../svc', '../gen'],
    allow_parallel=True,
    labels=['build'],
)


# Single docker image for all Go services - k8s manifests use `args` to specify which service to run
docker_build_with_restart(
    'unkey/go:latest',
    '..',
    dockerfile='./Dockerfile.tilt',
    entrypoint=['/unkey'],
    only=['./bin'],
    live_update=[sync('./bin/unkey', '/unkey')]
)

# Agent service
docker_build(
        'unkey/agent:latest',
        '../web/apps/agent',
        dockerfile='../web/apps/agent/Dockerfile',
    )
k8s_yaml('k8s/manifests/agent.yaml')
k8s_resource(
  'agent',
  port_forwards='8082:8080',
  resource_deps=['s3', 'clickhouse'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)


# Vault service
k8s_yaml('k8s/manifests/vault.yaml')
k8s_resource(
  'vault',
  port_forwards='8060:8060',
  resource_deps=['s3', 'build-unkey'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# API service
k8s_yaml('k8s/manifests/api.yaml')
k8s_resource(
  'api',
  port_forwards='7070:7070',
  resource_deps=['mysql', 'clickhouse', 'redis', 'build-unkey'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# Ctrl service
k8s_yaml('k8s/manifests/ctrl.yaml')
k8s_resource(
  'ctrl',
  port_forwards='7091:7091',
  resource_deps=['mysql', 'clickhouse', 'restate', 'build-unkey', 'depot-credentials'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# Krane service
k8s_yaml('k8s/manifests/krane.yaml')
k8s_resource(
  'krane',
  port_forwards='8070:8070',
  resource_deps=['build-unkey', 'rbac', 'namespace'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)




# Preflight (mutating admission controller for secrets and credentials injection)

# Build inject binary and image (auto-detect arch from minikube)
local_resource(
    'build-inject',
    'cd .. && CGO_ENABLED=0 GOOS=linux GOARCH=$(minikube ssh -- uname -m | sed "s/x86_64/amd64/" | sed "s/aarch64/arm64/" | tr -d "\\r") go build -o bin/inject ./cmd/inject && docker build -t inject:latest -f dev/Dockerfile.inject . && minikube image load inject:latest',
    deps=['../cmd/inject', '../pkg/secrets', '../pkg/cli'],
    allow_parallel=True,
    labels=['build'],
)

k8s_yaml('k8s/manifests/preflight.yaml')
k8s_resource(
  'preflight',
  port_forwards='8090:8080',
  resource_deps=['build-unkey', 'build-inject'],
  labels=['unkey'],
  auto_init=True,
  trigger_mode=TRIGGER_MODE_AUTO
)

# Sentinel image (same Go binary, used by ctrl to spawn sentinels)
docker_build(
    'unkey/sentinel:latest',
    '..',
    dockerfile='./Dockerfile.tilt',
    only=['./bin'],
)


# Dashboard service
docker_build(
  'unkey/dashboard:latest',
  '..',
  dockerfile='../web/apps/dashboard/Dockerfile',
  live_update=[
      sync('../web/apps/dashboard', '/unkey/web/apps/dashboard'),
      run('cd /unkey/web/apps/dashboard && pnpm build', trigger=['**/*.tsx', '**/*.ts', '**/*.css']),
  ]
)
k8s_yaml('k8s/manifests/dashboard.yaml')

k8s_resource(
    'dashboard',
    port_forwards='3000:3000',
    resource_deps=['mysql', 'clickhouse'],
    labels=['unkey'],
    auto_init=True,
    trigger_mode=TRIGGER_MODE_MANUAL
)

print("""
Tilt is ready!


Web UI: http://localhost:10350

Tips:
- Press 's' to open a shell in running containers
- Press 'r' to manually trigger rebuilds
- Use 'tilt down' to stop all services
- Use 'tilt logs <service>' to view specific service logs

""")
