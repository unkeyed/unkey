name: unkey
services:
  mysql:
    networks:
      - default
    container_name: mysql
    build:
      context: ..
      dockerfile: dev/Dockerfile.mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: unkey
      MYSQL_USER: unkey
      MYSQL_PASSWORD: password
    command: ["--max_connections=1000", "--skip-log-bin"]
    ports:
      - 3306:3306
    volumes:
      - mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      timeout: 20s
      retries: 10
      start_period: 40s
      interval: 10s

  planetscale:
    networks:
      - default
    container_name: planetscale
    image: ghcr.io/mattrobenolt/ps-http-sim:v0.0.12
    command:
      [
        "-listen-port=3900",
        "-mysql-dbname=unkey",
        "-mysql-addr=mysql",
        "-mysql-max-rows=100000",
        "-mysql-idle-timeout=1s",
      ]
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - 3900:3900

  apiv2_lb:
    networks:
      - default
    container_name: apiv2_lb
    image: nginx:1.29.0
    volumes:
      - ./nginx.apiv2.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - apiv2
    ports:
      - 2112:2112
      - 7070:7070

  apiv2:
    networks:
      - default
    deploy:
      replicas: 3
      endpoint_mode: vip
    command: ["run", "api"]
    build:
      context: ../
      dockerfile: ./Dockerfile
    depends_on:
      mysql:
        condition: service_healthy
      vault:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      ctrl-api:
        condition: service_started
    environment:
      UNKEY_HTTP_PORT: 7070
      UNKEY_REDIS_URL: "redis://redis:6379"
      UNKEY_DATABASE_PRIMARY: "unkey:password@tcp(mysql:3306)/unkey?parseTime=true"
      UNKEY_CLICKHOUSE_URL: "clickhouse://default:password@clickhouse:9000?secure=false&skip_verify=true"
      UNKEY_CHPROXY_AUTH_TOKEN: "chproxy-test-token-123"
      UNKEY_OTEL: false
      UNKEY_VAULT_URL: "http://vault:8060"
      UNKEY_VAULT_TOKEN: "vault-test-token-123"
      UNKEY_KAFKA_BROKERS: "kafka:9092"
      UNKEY_CLICKHOUSE_ANALYTICS_URL: "http://clickhouse:8123/default"
      UNKEY_CTRL_URL: "http://ctrl-api:7091"
      UNKEY_CTRL_TOKEN: "your-local-dev-key"
      UNKEY_PPROF_ENABLED: "true"
      UNKEY_PPROF_USERNAME: "admin"
      UNKEY_PPROF_PASSWORD: "password"

  redis:
    networks:
      - default
    container_name: redis
    image: redis:8.0
    ports:
      - 6379:6379
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 5s
      retries: 5
      start_period: 10s
      interval: 5s

  # Vault service for encryption and key management
  vault:
    networks:
      - default
    container_name: vault
    build:
      context: ../
      dockerfile: Dockerfile
    command: ["run", "vault"]
    ports:
      - "8060:8060"
    depends_on:
      s3:
        condition: service_healthy
    environment:
      UNKEY_HTTP_PORT: "8060"
      UNKEY_S3_URL: "http://s3:3902"
      UNKEY_S3_BUCKET: "vault"
      UNKEY_S3_ACCESS_KEY_ID: "minio_root_user"
      UNKEY_S3_ACCESS_KEY_SECRET: "minio_root_password"
      UNKEY_MASTER_KEYS: "Ch9rZWtfMmdqMFBJdVhac1NSa0ZhNE5mOWlLSnBHenFPENTt7an5MRogENt9Si6wms4pQ2XIvqNSIgNpaBenJmXgcInhu6Nfv2U="
      UNKEY_BEARER_TOKEN: "vault-test-token-123"
    healthcheck:
      test: ["CMD", "/unkey", "healthcheck", "http://localhost:8060/health/live"]
      timeout: 10s
      retries: 5
      start_period: 30s
      interval: 10s

  clickhouse:
    networks:
      - default
    build:
      context: ..
      dockerfile: dev/Dockerfile.clickhouse
    container_name: clickhouse
    environment:
      CLICKHOUSE_ADMIN_USER: default
      CLICKHOUSE_ADMIN_PASSWORD: password
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse:/bitnami/clickhouse
    healthcheck:
      test:
        [
          "CMD",
          "clickhouse-client",
          "--host",
          "localhost",
          "--user",
          "default",
          "--password",
          "password",
          "--query",
          "SELECT 1",
        ]
      timeout: 10s
      retries: 10
      start_period: 30s
      interval: 5s

  s3:
    networks:
      - default
    container_name: s3
    image: bitnamilegacy/minio:2025.7.23-debian-12-r5
    ports:
      - 3902:3902
      - 3903:3903
    environment:
      MINIO_ROOT_USER: minio_root_user
      MINIO_ROOT_PASSWORD: minio_root_password
      MINIO_API_PORT_NUMBER: 3902
      MINIO_CONSOLE_PORT_NUMBER: 3903
    volumes:
      - s3:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3902/minio/health/live"]
      timeout: 5s
      retries: 10
      start_period: 15s
      interval: 5s

  krane:
    build:
      context: ../
      dockerfile: Dockerfile
      args:
        VERSION: "latest"
    container_name: krane
    command: ["run", "krane"]
    ports:
      - "8070:8070"
    volumes:
      # Mount Docker socket for Docker backend support
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      vault:
        condition: service_healthy
    environment:
      # Server configuration
      UNKEY_REGION: "local.dev" # currently required to receive filtered events from ctrl
      UNKEY_CONTROL_PLANE_URL: "http://ctrl-api:7091"
      UNKEY_CONTROL_PLANE_BEARER: "your-local-dev-key"

      # Backend configuration - use Docker backend for development
      UNKEY_KRANE_BACKEND: "docker"
      UNKEY_DOCKER_SOCKET: "/var/run/docker.sock"

      # Vault configuration for secrets decryption
      UNKEY_VAULT_URL: "http://vault:8060"
      UNKEY_VAULT_TOKEN: "vault-test-token-123"

      UNKEY_REGISTRY_URL: "${UNKEY_REGISTRY_URL:-}"
      UNKEY_REGISTRY_USERNAME: "${UNKEY_REGISTRY_USERNAME:-}"
      UNKEY_REGISTRY_PASSWORD: "${UNKEY_REGISTRY_PASSWORD:-}"

  restate:
    networks:
      - default
    container_name: restate
    image: docker.io/restatedev/restate:1.6.0
    ports:
      - "8081:8080" # Frontline endpoint (host:container)
      - "9070:9070" # Admin endpoint and UI
    environment:
      RESTATE_TRACING_ENDPOINT: "http://otel:4317"
    depends_on:
      otel:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9070/health"]
      timeout: 5s
      retries: 10
      start_period: 10s
      interval: 5s

  ctrl-api:
    networks:
      - default
    build:
      context: ../
      dockerfile: Dockerfile
      args:
        VERSION: "latest"
    container_name: ctrl-api
    command: ["run", "ctrl", "api"]
    ports:
      - "7091:7091"
    depends_on:
      mysql:
        condition: service_healthy
        required: true
      s3:
        condition: service_healthy
        required: true
      restate:
        condition: service_healthy
        required: true
      clickhouse:
        condition: service_healthy
        required: true
    environment:
      UNKEY_DATABASE_PRIMARY: "unkey:password@tcp(mysql:3306)/unkey?parseTime=true&interpolateParams=true"

      # Control plane configuration
      UNKEY_HTTP_PORT: "7091"

      # Restate configuration (ctrl api only needs ingress client, not server)
      UNKEY_RESTATE_INGRESS_URL: "http://restate:8080"
      UNKEY_RESTATE_ADMIN_URL: "http://restate:9070"
      UNKEY_RESTATE_API_KEY: ""

      # Build configuration (for presigned URLs)
      UNKEY_BUILD_S3_URL: "${UNKEY_BUILD_S3_URL:-http://s3:3902}"
      UNKEY_BUILD_S3_EXTERNAL_URL: "${UNKEY_BUILD_S3_EXTERNAL_URL:-http://localhost:3902}"
      UNKEY_BUILD_S3_BUCKET: "build-contexts"
      UNKEY_BUILD_S3_ACCESS_KEY_ID: "${UNKEY_BUILD_S3_ACCESS_KEY_ID:-minio_root_user}"
      UNKEY_BUILD_S3_ACCESS_KEY_SECRET: "${UNKEY_BUILD_S3_ACCESS_KEY_SECRET:-minio_root_password}"

      # API key for simple authentication
      UNKEY_AUTH_TOKEN: "your-local-dev-key"

      # Certificate bootstrap
      UNKEY_DEFAULT_DOMAIN: "unkey.local"
      UNKEY_CNAME_DOMAIN: "unkey.local"

  ctrl-worker:
    networks:
      - default
    build:
      context: ../
      dockerfile: Dockerfile
      args:
        VERSION: "latest"
    container_name: ctrl-worker
    command: ["run", "ctrl", "worker"]
    env_file:
      - .env.depot
    ports:
      - "9080:9080"
    healthcheck:
      test: ["CMD", "/unkey", "healthcheck", "http://localhost:9080/health/live"]
      timeout: 5s
      retries: 5
      start_period: 10s
      interval: 5s
    depends_on:
      mysql:
        condition: service_healthy
        required: true
      s3:
        condition: service_healthy
        required: true
      restate:
        condition: service_healthy
        required: true
      clickhouse:
        condition: service_healthy
        required: true
      vault:
        condition: service_healthy
        required: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      UNKEY_DATABASE_PRIMARY: "unkey:password@tcp(mysql:3306)/unkey?parseTime=true&interpolateParams=true"

      # Domain configuration (used by deploy and routing services)
      UNKEY_DEFAULT_DOMAIN: "unkey.local"
      UNKEY_CNAME_DOMAIN: "unkey.local"

      # Restate configuration
      UNKEY_RESTATE_ADMIN_URL: "http://restate:9070"
      UNKEY_RESTATE_HTTP_PORT: "9080"
      UNKEY_RESTATE_REGISTER_AS: "http://ctrl-worker:9080"

      # Vault service for secret encryption
      UNKEY_VAULT_URL: "http://vault:8060"
      UNKEY_VAULT_TOKEN: "vault-test-token-123"

      # Build configuration (loaded from .env.depot)
      UNKEY_BUILD_S3_BUCKET: "build-contexts"

      # Build configuration
      UNKEY_BUILD_PLATFORM: "linux/amd64"

      # Registry configuration (UNKEY_REGISTRY_PASSWORD loaded from .env.depot)
      UNKEY_REGISTRY_URL: "registry.depot.dev"
      UNKEY_REGISTRY_USERNAME: "x-token"

      # Depot-specific configuration
      UNKEY_DEPOT_API_URL: "https://api.depot.dev"
      UNKEY_DEPOT_PROJECT_REGION: "us-east-1"

      # ClickHouse
      UNKEY_CLICKHOUSE_URL: "clickhouse://default:password@clickhouse:9000?secure=false&skip_verify=true"
      UNKEY_CLICKHOUSE_ADMIN_URL: "clickhouse://unkey_user_admin:C57RqT5EPZBqCJkMxN9mEZZEzMPcw9yBlwhIizk99t7kx6uLi9rYmtWObsXzdl@clickhouse:9000?secure=false&skip_verify=true"

      # Sentinel image for deployments
      UNKEY_SENTINEL_IMAGE: "unkey/sentinel:latest"

  otel:
    networks:
      - default
    image: grafana/otel-lgtm:0.11.7
    container_name: otel
    hostname: otel
    ports:
      - 3001:3000
      - 4317:4317
      - 4318:4318

  prometheus:
    networks:
      - default
    image: prom/prometheus:v3.5.0
    container_name: prometheus
    ports:
      - 9090:9090
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
    depends_on:
      - apiv2

  dashboard:
    networks:
      - default
    build:
      context: ..
      dockerfile: ./web/apps/dashboard/Dockerfile
    container_name: unkey-dashboard
    ports:
      - "3000:3000"
    depends_on:
      planetscale:
        condition: service_started
        required: true
    env_file:
      - ../web/apps/dashboard/.env
    environment:
      # Database configuration
      DATABASE_HOST: "planetscale:3900"
      # Auth configuration
      # Reading from env file, no override necessary
      # Clickhouse configuration
      CLICKHOUSE_URL: "http://default:password@clickhouse:8123"
      # Environment
      NODE_ENV: "production"
      CTRL_URL: "http://ctrl-api:7091"
      CTRL_API_KEY: "your-local-dev-key"
      # Bootstrap workspace/API IDs
      # Reading from env file, no override necessary
volumes:
  mysql:
  clickhouse:
  clickhouse-keeper:
  s3:

networks:
  default:
