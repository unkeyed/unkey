---
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontline-config
  namespace: unkey
data:
  unkey.toml: |
    region = "local.dev"
    http_port = 7070
    https_port = 7443
    apex_domain = "unkey.local"
    ctrl_addr = "http://ctrl-api:7091"

    [tls]
    enabled = true
    cert_file = "/certs/unkey.local.crt"
    key_file = "/certs/unkey.local.key"

    [database]
    primary = "unkey:password@tcp(mysql:3306)/unkey?parseTime=true&interpolateParams=true"

    [gossip]
    lan_port = 7946
    lan_seeds = ["frontline-gossip-lan"]
    secret_key = "dGhpcy1pcy1hLWRldi1vbmx5LWdvc3NpcC1rZXkh"

    [otel]
    enabled = false

    [vault]
    url = "http://vault:8060"
    token = "vault-test-token-123"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontline
  namespace: unkey
  labels:
    app: frontline
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontline
  template:
    metadata:
      labels:
        app: frontline
    spec:
      containers:
        - name: frontline
          image: unkey/go:latest
          args: ["run", "frontline", "--config", "/etc/unkey/unkey.toml"]
          imagePullPolicy: Never
          ports:
            - containerPort: 7070
              name: http
            - containerPort: 7443
              name: https
            - containerPort: 7946
              name: gossip-lan
              protocol: TCP
            - containerPort: 7946
              name: gossip-lan-udp
              protocol: UDP
          volumeMounts:
            - name: config
              mountPath: /etc/unkey
              readOnly: true
            - name: tls-certs
              mountPath: /certs
              readOnly: true
          readinessProbe:
            httpGet:
              path: /_unkey/internal/health/ready
              port: 7070
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /_unkey/internal/health/live
              port: 7070
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: frontline-config
        - name: tls-certs
          configMap:
            name: frontline-certs
      initContainers:
        - name: wait-for-dependencies
          image: busybox:1.36
          command:
            [
              "sh",
              "-c",
              "until nc -z mysql 3306 && nc -z ctrl-api 7091 && nc -z vault 8060; do sleep 2; done",
            ]
---
apiVersion: v1
kind: Service
metadata:
  name: frontline
  namespace: unkey
spec:
  selector:
    app: frontline
  ports:
    - name: http
      port: 80
      targetPort: 7070
    - name: https
      port: 443
      targetPort: 7443
  type: LoadBalancer

---
apiVersion: v1
kind: Service
metadata:
  name: frontline-gossip-lan
  namespace: unkey
spec:
  clusterIP: None
  selector:
    app: frontline
  ports:
    - name: gossip-lan
      port: 7946
      targetPort: 7946
      protocol: TCP
    - name: gossip-lan-udp
      port: 7946
      targetPort: 7946
      protocol: UDP
