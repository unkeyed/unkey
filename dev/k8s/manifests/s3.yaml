apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: s3-pvc
  namespace: unkey
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: s3
  namespace: unkey
  labels:
    app: s3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: s3
  template:
    metadata:
      labels:
        app: s3
    spec:
      containers:
        - name: minio
          image: bitnamilegacy/minio:2025.7.23-debian-12-r5
          ports:
            - containerPort: 3902
              name: api
            - containerPort: 3903
              name: console
          env:
            - name: MINIO_ROOT_USER
              value: "minio_root_user"
            - name: MINIO_ROOT_PASSWORD
              value: "minio_root_password"
            - name: MINIO_API_PORT_NUMBER
              value: "3902"
            - name: MINIO_CONSOLE_PORT_NUMBER
              value: "3903"
            - name: MINIO_DEFAULT_BUCKETS
              value: "vault"
          volumeMounts:
            - name: s3-storage
              mountPath: /data
          readinessProbe:
            httpGet:
              path: /minio/health/ready
              port: 3902
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /minio/health/live
              port: 3902
            initialDelaySeconds: 60
            periodSeconds: 30
      volumes:
        - name: s3-storage
          persistentVolumeClaim:
            claimName: s3-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: s3
  namespace: unkey
  labels:
    app: s3
spec:
  selector:
    app: s3
  ports:
    - name: api
      port: 3902
      targetPort: 3902
      protocol: TCP
    - name: console
      port: 3903
      targetPort: 3903
      protocol: TCP
  type: ClusterIP
