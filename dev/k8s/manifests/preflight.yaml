---
# ServiceAccount for the preflight
apiVersion: v1
kind: ServiceAccount
metadata:
  name: preflight
  namespace: unkey
---
# ClusterRole for the webhook to read pods and registry auth
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: preflight
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "delete"]
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get"]
  - apiGroups: ["admissionregistration.k8s.io"]
    resources: ["mutatingwebhookconfigurations"]
    verbs: ["get", "patch"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: preflight
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: preflight
subjects:
  - kind: ServiceAccount
    name: preflight
    namespace: unkey
---
# Deployment for the preflight
apiVersion: apps/v1
kind: Deployment
metadata:
  name: preflight
  namespace: unkey
  labels:
    app: preflight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: preflight
  template:
    metadata:
      labels:
        app: preflight
    spec:
      serviceAccountName: preflight
      initContainers:
        - name: cert-gen
          image: alpine/openssl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              # Generate CA
              openssl genrsa -out /certs/ca.key 2048
              openssl req -x509 -new -nodes -key /certs/ca.key -sha256 -days 365 \
                  -out /certs/ca.crt -subj "/CN=preflight-ca"
              # Generate server key and CSR
              openssl genrsa -out /certs/tls.key 2048
              openssl req -new -key /certs/tls.key -out /tmp/tls.csr \
                  -subj "/CN=preflight.unkey.svc"
              # Create SAN extension file
              cat > /tmp/ext.cnf << EOF
              subjectAltName=DNS:preflight.unkey.svc,DNS:preflight.unkey.svc.cluster.local
              EOF
              # Sign the cert
              openssl x509 -req -in /tmp/tls.csr -CA /certs/ca.crt -CAkey /certs/ca.key \
                  -CAcreateserial -out /certs/tls.crt -days 365 -sha256 -extfile /tmp/ext.cnf
              chmod 644 /certs/*.crt /certs/*.key
              echo "Certificates generated successfully"
          volumeMounts:
            - name: tls-certs
              mountPath: /certs
      containers:
        - name: webhook
          image: unkey/go:latest
          args: ["run", "preflight"]
          imagePullPolicy: IfNotPresent
          env:
            - name: UNKEY_HTTP_PORT
              value: "8443"
            - name: UNKEY_TLS_CERT_FILE
              value: "/certs/tls.crt"
            - name: UNKEY_TLS_KEY_FILE
              value: "/certs/tls.key"
            - name: UNKEY_INJECT_IMAGE
              value: "inject:latest"
            - name: UNKEY_INJECT_IMAGE_PULL_POLICY
              value: "Never" # Local dev uses pre-loaded images; use IfNotPresent in prod
            - name: UNKEY_KRANE_ENDPOINT
              value: "http://krane.unkey.svc.cluster.local:8070"
            - name: UNKEY_INSECURE_REGISTRIES
              value: "ctlptl-registry.unkey.svc.cluster.local:5000"
            - name: UNKEY_REGISTRY_ALIASES
              value: "ctlptl-registry:5000=ctlptl-registry.unkey.svc.cluster.local:5000"
            - name: UNKEY_DEPOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: depot-credentials
                  key: UNKEY_DEPOT_TOKEN
                  optional: true
          ports:
            - containerPort: 8443
              name: https
          volumeMounts:
            - name: tls-certs
              mountPath: /certs
              readOnly: true
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 10
        - name: ca-patcher
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for CA cert..."
              while [ ! -f /certs/ca.crt ]; do sleep 1; done
              CA_BUNDLE=$(cat /certs/ca.crt | base64 | tr -d '\n')
              echo "Patching MutatingWebhookConfiguration..."
              kubectl patch mutatingwebhookconfiguration preflight \
                --type='json' \
                -p="[{\"op\": \"replace\", \"path\": \"/webhooks/0/clientConfig/caBundle\", \"value\": \"${CA_BUNDLE}\"}]"
              echo "Webhook patched successfully, sleeping..."
              sleep infinity
          volumeMounts:
            - name: tls-certs
              mountPath: /certs
              readOnly: true
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 50m
              memory: 64Mi
      volumes:
        - name: tls-certs
          emptyDir: {}
---
# Service for the webhook
apiVersion: v1
kind: Service
metadata:
  name: preflight
  namespace: unkey
spec:
  selector:
    app: preflight
  ports:
    - port: 443
      targetPort: 8443
      protocol: TCP
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: preflight
webhooks:
  - name: preflight.unkey.com
    clientConfig:
      service:
        name: preflight
        namespace: unkey
        path: /mutate
        port: 443
      caBundle: ""
    rules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["pods"]
        scope: Namespaced
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values: ["kube-system"]
    objectSelector:
      matchExpressions:
        - key: unkey.com/inject
          operator: In
          values: ["true"]
    failurePolicy: Fail
    reinvocationPolicy: Never
    sideEffects: NoneOnDryRun
    admissionReviewVersions: ["v1"]
    timeoutSeconds: 30
