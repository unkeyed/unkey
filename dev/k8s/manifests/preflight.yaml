---
# ServiceAccount for the preflight
apiVersion: v1
kind: ServiceAccount
metadata:
  name: preflight
  namespace: unkey
---
# ClusterRole for the webhook to read pods and registry auth
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: preflight
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "delete"]
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: preflight
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: preflight
subjects:
  - kind: ServiceAccount
    name: preflight
    namespace: unkey
---
# TLS Secret for webhook is created by Tiltfile (local dev) or cert-manager (production)
# For manual setup: mkcert -cert-file tls.crt -key-file tls.key preflight.unkey.svc preflight.unkey.svc.cluster.local
#                   kubectl create secret tls preflight-tls -n unkey --cert=tls.crt --key=tls.key
---
# Deployment for the preflight
apiVersion: apps/v1
kind: Deployment
metadata:
  name: preflight
  namespace: unkey
  labels:
    app: preflight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: preflight
  template:
    metadata:
      labels:
        app: preflight
    spec:
      serviceAccountName: preflight
      containers:
        - name: webhook
          image: unkey/preflight:latest
          imagePullPolicy: IfNotPresent
          command: ["/unkey", "run", "preflight"]
          env:
            - name: WEBHOOK_PORT
              value: "8443"
            - name: WEBHOOK_TLS_CERT_FILE
              value: "/certs/tls.crt"
            - name: WEBHOOK_TLS_KEY_FILE
              value: "/certs/tls.key"
            - name: INJECT_IMAGE
              value: "inject:latest"
            - name: INJECT_IMAGE_PULL_POLICY
              value: "Never" # Local dev uses pre-loaded images; use IfNotPresent in prod
            - name: KRANE_ENDPOINT
              value: "http://krane.unkey.svc.cluster.local:8080"
            - name: UNKEY_DEPOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: depot-credentials
                  key: token
          ports:
            - containerPort: 8443
              name: https
          volumeMounts:
            - name: tls-certs
              mountPath: /certs
              readOnly: true
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tls-certs
          secret:
            secretName: preflight-tls
---
# Service for the webhook
apiVersion: v1
kind: Service
metadata:
  name: preflight
  namespace: unkey
spec:
  selector:
    app: preflight
  ports:
    - port: 443
      targetPort: 8443
      protocol: TCP
---
# MutatingWebhookConfiguration
# caBundle must be set to mkcert's root CA:
#   cat "$(mkcert -CAROOT)/rootCA.pem" | base64 | tr -d '\n'
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: preflight
webhooks:
  - name: preflight.unkey.com
    clientConfig:
      service:
        name: preflight
        namespace: unkey
        path: /mutate
        port: 443
      caBundle: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUU3ekNDQTFlZ0F3SUJBZ0lRQ2ZuMEZBZmhDZW80MzR0QUFYVWVEekFOQmdrcWhraUc5dzBCQVFzRkFEQ0IKanpFZU1Cd0dBMVVFQ2hNVmJXdGpaWEowSUdSbGRtVnNiM0J0Wlc1MElFTkJNVEl3TUFZRFZRUUxEQ2xqYUhKdgpibUZ5YTBCTllXTkNiMjlyVUhKdkxteHZZMkZzWkc5dFlXbHVJQ2hCYm1SeVpXRnpLVEU1TURjR0ExVUVBd3d3CmJXdGpaWEowSUdOb2NtOXVZWEpyUUUxaFkwSnZiMnRRY204dWJHOWpZV3hrYjIxaGFXNGdLRUZ1WkhKbFlYTXAKTUI0WERUSTFNVEl5T1RBNE1UY3pNbG9YRFRNMU1USXlPVEE0TVRjek1sb3dnWTh4SGpBY0JnTlZCQW9URlcxcgpZMlZ5ZENCa1pYWmxiRzl3YldWdWRDQkRRVEV5TURBR0ExVUVDd3dwWTJoeWIyNWhjbXRBVFdGalFtOXZhMUJ5CmJ5NXNiMk5oYkdSdmJXRnBiaUFvUVc1a2NtVmhjeWt4T1RBM0JnTlZCQU1NTUcxclkyVnlkQ0JqYUhKdmJtRnkKYTBCTllXTkNiMjlyVUhKdkxteHZZMkZzWkc5dFlXbHVJQ2hCYm1SeVpXRnpLVENDQWFJd0RRWUpLb1pJaHZjTgpBUUVCQlFBRGdnR1BBRENDQVlvQ2dnR0JBTWVYLzdZYmNyRmVqK3lGUWZBb1VmWGZFdGlCYUNBRmJnSDBsTDdpCjhJTHNNQUVkU2o1UVBTVUF5L3hvV0h3cDlaNWRza2pxOCtqNHlhL1pHN0dLVERTazcyaFB5TkFlSU41ejdOa2wKYmFERlBuejE1TkJnQ3NJM0g2Z1pjdmNTVE9ZMlRJUDAza2FETHRONjRMS0RXOEhUN2FFOVI2aVJJUUlXWExUdgpBQnhRNC9WeFdLajZVdVp0b3FxSWVMZGlxRUVnRjF3cUU0WkVhNlVzM0VpdjcwL0Q2UWE4aVdzZi80ZjFXbitPCjY1dkFOK2tPVWU4UWROZ0NPRnFZYzRZcWVrSlVXaVVIeFh4bm1IOGE1Z1RPOXdTZGpQUzdoY1N5SEp1cFIyMUkKNXpRQ25zTFlZUHR6aHpqeCs0bjRkR1owemkvSGVSeW5QVlQ4RmhUczkvSUZjTUxxUnJDVHY1L3phaE10bzRERQorQ0VzZUNCT1dVWnJWc2tsclBvRGE1Vktzc1FxRVlZdEppN0RLRUVQUXRnbktCa0x4RTViWHZra0dnR2xGaTliCmxGMzNFUXp4SHdqRXc3ZytZVTczL280MklrTU4yWEorZmFwOTYxaDBRbXdLUEFTU2pCM2poUlQvOVpJdHpMVy8KSDFRVXVEck1JdkhLU3Vrbkg0U0Z6K2JaeXdJREFRQUJvMFV3UXpBT0JnTlZIUThCQWY4RUJBTUNBZ1F3RWdZRApWUjBUQVFIL0JBZ3dCZ0VCL3dJQkFEQWRCZ05WSFE0RUZnUVVtRUtMY0Rtb0Z5Vlo5bHRXZVc4d1g2REJVR0V3CkRRWUpLb1pJaHZjTkFRRUxCUUFEZ2dHQkFKektUT29NOFhNb0hsbmRxVUJFRFU1V2F5dG01U3VzQTdQNTEwOXAKUVJvbGF0d3pQU2JxandEYVpCTmRHRld5ZmFkQTZnUVVhd0ZaNWh4alA1QnhyMVVxY1hFZDVCTDhESDFoeFJyZworQ1VCNnI0T2ZNYzVtcUJnc1VzSkg4SE54RVp6Y2xHbFM2MWNmTmU0WlQ4Q1g5b1lpczFPL3dOY3pnZEpxMENOCmVHb0NTUXdMMHIycDhGeWM1NzFBVVhxaGRwRVY3N0gzbW9BSzlkZU96WVY4M04rT0h0SzFvZ2hCN1IrTWJlMEcKc0hhUjBidUFKZUxnN2lXVkZuUnVtdzBnZ2JoRklnMGo1Q1RaVzJqcTBpVTJDdklPbkRxSUVVQnJhUDNuK09tQgpaQmtGc0NhRUFBTkRGUGlYb1Z5NDNRN1ZzMjUzdlpBTm9MMkt4Q2lTT0s4OXViZ2E0WGswR3d5bTNyTWZyeXFNCjA5N2N6Z1d4QUQ3RDROZGJGbmVNMElidzhWZ0MrbFpkODhRVG9udlNxYzVDYjlsUm43VTFtZGRxc0cvSERaZloKT3ZFcmlGcTR3Ym43MlAzWEY2Y3NMSDFGK3l6WFJxNGhaRGYwRlNEQmhnTkxGcXlvRjkyZDZ1V0pNWVFjMk1OVQo4WTFmUSt5SlBtMmRrMFFRMjNmTHoxNjdYdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
    rules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["pods"]
        scope: Namespaced
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values: ["kube-system"]
    objectSelector:
      matchExpressions:
        - key: unkey.com/inject
          operator: In
          values: ["true"]
    failurePolicy: Fail
    reinvocationPolicy: Never
    sideEffects: NoneOnDryRun
    admissionReviewVersions: ["v1"]
    timeoutSeconds: 30
