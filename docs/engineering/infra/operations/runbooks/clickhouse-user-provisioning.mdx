---
title: "Provisioning ClickHouse users"
description: "Set up analytics API access for workspaces"
---

This runbook explains how to provision a ClickHouse user for a workspace using the v2 analytics API.

## Prerequisites

- `control worker` running with `UNKEY_CLICKHOUSE_ADMIN_URL` configured
- Restate accessible

## Provisioning a new user

Call the `ConfigureUser` endpoint via Restate:

```bash
curl -X POST "http://restate:8080/hydra.v1.ClickhouseUserService/ws_abc123/ConfigureUser" \
  -H "Content-Type: application/json" \
  -d '{}'
```

The workflow will:

1. Generate a secure password
2. Encrypt it via Vault
3. Store credentials in MySQL
4. Create the ClickHouse user with row-level security

## Customizing quotas

Override defaults by passing quota parameters:

```bash
curl -X POST "http://restate:8080/hydra.v1.ClickhouseUserService/ws_abc123/ConfigureUser" \
  -H "Content-Type: application/json" \
  -d '{
    "max_queries_per_window": 500,
    "max_query_execution_time": 60
  }'
```

| Parameter | Default | Description |
| --- | --- | --- |
| `quota_duration_seconds` | 3600 | Window for rate limits (1 hour) |
| `max_queries_per_window` | 1000 | Queries allowed per window |
| `max_execution_time_per_window` | 1800 | Total query time per window (30 min) |
| `max_query_execution_time` | 30 | Single query timeout (seconds) |
| `max_query_memory_bytes` | 1GB | Memory limit per query |
| `max_query_result_rows` | 10M | Max rows returned |

## Updating an existing user

Use the same endpoint. The workflow detects the user exists and updates quotas while preserving the password.

```bash
curl -X POST "http://restate:8080/hydra.v1.ClickhouseUserService/ws_abc123/ConfigureUser" \
  -H "Content-Type: application/json" \
  -d '{
    "max_queries_per_window": 2000
  }'
```

## Via Restate UI (local)

1. Open Restate UI (`http://localhost:8080/ui` in dev).
2. Find `hydra.v1.ClickhouseUserService`.
3. Enter the workspace ID as the key.
4. Call `ConfigureUser`.

## Via Restate Cloud (production)

1. Go to <a href="https://cloud.restate.dev/accounts" target="_blank">cloud.restate.dev/accounts</a>.
2. Log in with Google Auth and select the **unkey** team.
3. Get your API key from AWS Secrets Manager, or create one in Restate Cloud under **Developers**.

### Via UI

1. Find `hydra.v1.ClickhouseUserService` and click **Playground**.
2. Enter your API key in **Auth**.
3. Set `key` to the workspace ID in **Parameters**.
4. Click **Send API Request**.

### Via curl

```bash
curl -X POST "https://<environment-id>.env.<region>.restate.cloud:8080/hydra.v1.ClickhouseUserService/ws_abc123/ConfigureUser" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <your-api-key>" \
  -d '{}'
```

Find `<environment-id>` and `<region>` in the Restate Cloud dashboard.

## What gets created

For workspace `ws_abc123`, the workflow creates:

- User `ws_abc123` with encrypted password
- Row policies per table filtered to `workspace_id = 'ws_abc123'` and retention window
- Quota rate limits on queries and execution time
- Settings profile for memory and result size limits

## Troubleshooting

### Service not found

The `ClickhouseUserService` is optional. Check:

- `UNKEY_CLICKHOUSE_ADMIN_URL` is set in control worker
- control worker logs for connection errors

### Quota exceeded errors

Re-run `ConfigureUser` with higher quota values.

### Password issues

If a user cannot authenticate, the ClickHouse password may be out of sync with MySQL. Delete from both and re-run the workflow:

```sql
DROP USER IF EXISTS ws_abc123;
```

```sql
DELETE FROM clickhouse_workspace_settings WHERE workspace_id = 'ws_abc123';
```
