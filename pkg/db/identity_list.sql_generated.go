// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: identity_list.sql

package db

import (
	"context"
	"database/sql"
)

const listIdentities = `-- name: ListIdentities :many
SELECT
    i.id,
    i.external_id,
    i.workspace_id,
    i.environment,
    i.meta,
    i.deleted,
    i.created_at,
    i.updated_at,
    COALESCE(
        (SELECT JSON_ARRAYAGG(
            JSON_OBJECT(
                'id', r.id,
                'name', r.name,
                'limit', r.` + "`" + `limit` + "`" + `,
                'duration', r.duration,
                'auto_apply', r.auto_apply = 1
            )
        )
        FROM ratelimits r
        WHERE r.identity_id = i.id),
        JSON_ARRAY()
    ) as ratelimits
FROM identities i
WHERE i.workspace_id = ?
AND i.deleted = ?
AND i.id >= ?
ORDER BY i.id ASC
LIMIT ?
`

type ListIdentitiesParams struct {
	WorkspaceID string `db:"workspace_id"`
	Deleted     bool   `db:"deleted"`
	IDCursor    string `db:"id_cursor"`
	Limit       int32  `db:"limit"`
}

type ListIdentitiesRow struct {
	ID          string        `db:"id"`
	ExternalID  string        `db:"external_id"`
	WorkspaceID string        `db:"workspace_id"`
	Environment string        `db:"environment"`
	Meta        []byte        `db:"meta"`
	Deleted     bool          `db:"deleted"`
	CreatedAt   int64         `db:"created_at"`
	UpdatedAt   sql.NullInt64 `db:"updated_at"`
	Ratelimits  interface{}   `db:"ratelimits"`
}

// ListIdentities
//
//	SELECT
//	    i.id,
//	    i.external_id,
//	    i.workspace_id,
//	    i.environment,
//	    i.meta,
//	    i.deleted,
//	    i.created_at,
//	    i.updated_at,
//	    COALESCE(
//	        (SELECT JSON_ARRAYAGG(
//	            JSON_OBJECT(
//	                'id', r.id,
//	                'name', r.name,
//	                'limit', r.`limit`,
//	                'duration', r.duration,
//	                'auto_apply', r.auto_apply = 1
//	            )
//	        )
//	        FROM ratelimits r
//	        WHERE r.identity_id = i.id),
//	        JSON_ARRAY()
//	    ) as ratelimits
//	FROM identities i
//	WHERE i.workspace_id = ?
//	AND i.deleted = ?
//	AND i.id >= ?
//	ORDER BY i.id ASC
//	LIMIT ?
func (q *Queries) ListIdentities(ctx context.Context, db DBTX, arg ListIdentitiesParams) ([]ListIdentitiesRow, error) {
	rows, err := db.QueryContext(ctx, listIdentities,
		arg.WorkspaceID,
		arg.Deleted,
		arg.IDCursor,
		arg.Limit,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []ListIdentitiesRow
	for rows.Next() {
		var i ListIdentitiesRow
		if err := rows.Scan(
			&i.ID,
			&i.ExternalID,
			&i.WorkspaceID,
			&i.Environment,
			&i.Meta,
			&i.Deleted,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.Ratelimits,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
