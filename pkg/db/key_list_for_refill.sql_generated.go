// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: key_list_for_refill.sql

package db

import (
	"context"
	"database/sql"
)

const listKeysForRefill = `-- name: ListKeysForRefill :many
SELECT id, workspace_id, refill_amount, remaining_requests, name
FROM ` + "`" + `keys` + "`" + `
WHERE refill_amount IS NOT NULL
  AND deleted_at_m IS NULL
  AND (remaining_requests IS NULL OR refill_amount > remaining_requests)
  AND (
      refill_day IS NULL
      OR refill_day = ?
      OR (? = 1 AND refill_day > ?)
  )
ORDER BY id
LIMIT ? OFFSET ?
`

type ListKeysForRefillParams struct {
	TodayDay         sql.NullInt16 `db:"today_day"`
	IsLastDayOfMonth interface{}   `db:"is_last_day_of_month"`
	Limit            int32         `db:"limit"`
	Offset           int32         `db:"offset"`
}

type ListKeysForRefillRow struct {
	ID                string         `db:"id"`
	WorkspaceID       string         `db:"workspace_id"`
	RefillAmount      sql.NullInt32  `db:"refill_amount"`
	RemainingRequests sql.NullInt32  `db:"remaining_requests"`
	Name              sql.NullString `db:"name"`
}

// ListKeysForRefill returns keys that need their remaining_requests refilled.
// Uses idx_keys_refill index for efficient lookup.
// Keys are selected if:
//   - refill_day is NULL (daily refill)
//   - refill_day matches today's day of month
//   - refill_day > today's day AND today is the last day of month (catch-up for short months)
//
// Keys are skipped if remaining_requests >= refill_amount (already full).
//
//	SELECT id, workspace_id, refill_amount, remaining_requests, name
//	FROM `keys`
//	WHERE refill_amount IS NOT NULL
//	  AND deleted_at_m IS NULL
//	  AND (remaining_requests IS NULL OR refill_amount > remaining_requests)
//	  AND (
//	      refill_day IS NULL
//	      OR refill_day = ?
//	      OR (? = 1 AND refill_day > ?)
//	  )
//	ORDER BY id
//	LIMIT ? OFFSET ?
func (q *Queries) ListKeysForRefill(ctx context.Context, db DBTX, arg ListKeysForRefillParams) ([]ListKeysForRefillRow, error) {
	rows, err := db.QueryContext(ctx, listKeysForRefill,
		arg.TodayDay,
		arg.IsLastDayOfMonth,
		arg.TodayDay,
		arg.Limit,
		arg.Offset,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []ListKeysForRefillRow
	for rows.Next() {
		var i ListKeysForRefillRow
		if err := rows.Scan(
			&i.ID,
			&i.WorkspaceID,
			&i.RefillAmount,
			&i.RemainingRequests,
			&i.Name,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
