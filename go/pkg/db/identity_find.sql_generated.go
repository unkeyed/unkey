// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: identity_find.sql

package db

import (
	"context"
	"database/sql"
)

const findIdentity = `-- name: FindIdentity :one
SELECT
    i.id, i.external_id, i.workspace_id, i.environment, i.meta, i.deleted, i.created_at, i.updated_at,
    COALESCE(
        (SELECT JSON_ARRAYAGG(
            JSON_OBJECT(
                'id', rl.id,
                'name', rl.name,
                'key_id', rl.key_id,
                'identity_id', rl.identity_id,
                'limit', rl.` + "`" + `limit` + "`" + `,
                'duration', rl.duration,
                'auto_apply', rl.auto_apply = 1
            )
        )
        FROM ratelimits rl WHERE rl.identity_id = i.id),
        JSON_ARRAY()
    ) as ratelimits
FROM identities i
WHERE i.id IN (
    SELECT id1.id FROM identities id1
    WHERE id1.id = ?
      AND id1.workspace_id = ?
      AND id1.deleted = ?
    LIMIT 1
    UNION ALL
    SELECT id2.id FROM identities id2
    WHERE id2.workspace_id = ?
      AND id2.external_id = ?
      AND id2.deleted = ?
    LIMIT 1
)
LIMIT 1
`

type FindIdentityParams struct {
	Identity    string `db:"identity"`
	WorkspaceID string `db:"workspace_id"`
	Deleted     bool   `db:"deleted"`
}

type FindIdentityRow struct {
	ID          string        `db:"id"`
	ExternalID  string        `db:"external_id"`
	WorkspaceID string        `db:"workspace_id"`
	Environment string        `db:"environment"`
	Meta        []byte        `db:"meta"`
	Deleted     bool          `db:"deleted"`
	CreatedAt   int64         `db:"created_at"`
	UpdatedAt   sql.NullInt64 `db:"updated_at"`
	Ratelimits  interface{}   `db:"ratelimits"`
}

// FindIdentity
//
//	SELECT
//	    i.id, i.external_id, i.workspace_id, i.environment, i.meta, i.deleted, i.created_at, i.updated_at,
//	    COALESCE(
//	        (SELECT JSON_ARRAYAGG(
//	            JSON_OBJECT(
//	                'id', rl.id,
//	                'name', rl.name,
//	                'key_id', rl.key_id,
//	                'identity_id', rl.identity_id,
//	                'limit', rl.`limit`,
//	                'duration', rl.duration,
//	                'auto_apply', rl.auto_apply = 1
//	            )
//	        )
//	        FROM ratelimits rl WHERE rl.identity_id = i.id),
//	        JSON_ARRAY()
//	    ) as ratelimits
//	FROM identities i
//	WHERE i.id IN (
//	    SELECT id1.id FROM identities id1
//	    WHERE id1.id = ?
//	      AND id1.workspace_id = ?
//	      AND id1.deleted = ?
//	    LIMIT 1
//	    UNION ALL
//	    SELECT id2.id FROM identities id2
//	    WHERE id2.workspace_id = ?
//	      AND id2.external_id = ?
//	      AND id2.deleted = ?
//	    LIMIT 1
//	)
//	LIMIT 1
func (q *Queries) FindIdentity(ctx context.Context, db DBTX, arg FindIdentityParams) (FindIdentityRow, error) {
	row := db.QueryRowContext(ctx, findIdentity,
		arg.Identity,
		arg.WorkspaceID,
		arg.Deleted,
		arg.WorkspaceID,
		arg.Identity,
		arg.Deleted,
	)
	var i FindIdentityRow
	err := row.Scan(
		&i.ID,
		&i.ExternalID,
		&i.WorkspaceID,
		&i.Environment,
		&i.Meta,
		&i.Deleted,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Ratelimits,
	)
	return i, err
}
