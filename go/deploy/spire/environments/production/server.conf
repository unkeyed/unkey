# SPIRE Server Configuration - Production Environment

server {
  # Consider using a load balancer or service mesh for external access
  bind_address = "127.0.0.1"
  socket_path = "/var/lib/spire/server/server.sock"
  trust_domain = "production.unkey.cloud"
  data_dir = "/var/lib/spire/server/data"
  log_level = "INFO"
  log_format = "json" # Structured logging for production

  default_x509_svid_ttl = "1h"
  default_jwt_svid_ttl = "5m"

  ca_ttl = "8760h"
  ca_key_type = "ec-p256"
  ca_subject = {
    country = ["US"],
    organization = ["Unkey"],
    common_name = "Unkey Production CA",
  }

  audit_log_enabled = true

  # federation {
  #   bundle_endpoint {
  #     address = "https://spire-bundle.unkey.cloud"
  #     port = 443
  #   }
  # }
}

plugins {
  DataStore "sql" {
    plugin_data {
      database_type = "postgres"
      connection_string = "${UNKEY_SPIRE_DB_CONNECTION}"

      # Connection pool configuration
      max_open_conns = 20
      max_idle_conns = 10
      conn_max_lifetime = "300s"
    }
  }

  NodeAttestor "aws_iid" {
    plugin_data {
      # AWS SDK will use instance profile automatically
      # trust_domain inherited from server config

      account_allowlist = ["${UNKEY_AWS_ACCOUNT_ID}"]

      # instance_allowlist = ["i-*"]
    }
  }

  NodeAttestor "join_token" {
    plugin_data {}
  }

  KeyManager "aws_kms" {
    plugin_data {
      region = "${AWS_REGION:-us-east-1}"
      key_metadata_file = "/etc/spire/server/kms-keys.json"
      # Uses IAM role, no explicit credentials needed
    }
  }

  # UpstreamAuthority "aws_pca" {
  #   plugin_data {
  #     region = "${AWS_REGION}"
  #     certificate_authority_arn = "${UNKEY_PCA_ARN}"
  #   }
  # }
}

health_checks {
  listener_enabled = true
  bind_address = "127.0.0.1"
  live_path = "/live"
  ready_path = "/ready"
}

telemetry {
  Prometheus {
    host = "127.0.0.1"
    port = 9988
  }

  metric_labels = [
    {env = "prod"},
    {service = "spire-server"},
    {region = "${AWS_REGION:-us-east-1}"}
  ]

  # DogStatsd = [{
  #   address = "127.0.0.1:8125"
  # }]
}
