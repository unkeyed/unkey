# SPIRE Agent Configuration - Production Environment
# AIDEV-NOTE: Production configuration with security hardening

agent {
  data_dir = "/var/lib/spire/agent/data"
  log_level = "WARN"
  log_format = "json"
  
  # Server connection configuration
  server_address = "127.0.0.1"
  server_port = "8085"
  socket_path = "/run/spire/sockets/agent.sock"
  
  # Production trust domain
  trust_domain = "prod.unkey.app"
  
  # Bootstrap bundle for initial trust
  trust_bundle_path = "/etc/spire/agent/bootstrap.crt"
  
  # Workload API configuration
  authorized_delegates = []
}

plugins {
  # AWS IID attestation for production EC2 instances
  # AIDEV-TODO: Enable when deploying to AWS
  # NodeAttestor "aws_iid" {
  #   plugin_data {
  #     trust_domain = "prod.unkey.app"
  #     account_id = "YOUR_AWS_ACCOUNT_ID"
  #     instance_profile_arn = "arn:aws:iam::YOUR_ACCOUNT:instance-profile/spire-agent"
  #   }
  # }
  
  # Fallback to join token for non-AWS deployments
  NodeAttestor "join_token" {
    plugin_data {
      # Token provided via secure provisioning only
    }
  }
  
  # Disk-based key storage
  KeyManager "disk" {
    plugin_data {
      directory = "/var/lib/spire/agent/keys"
    }
  }
  
  # Unix workload attestor for process-based identity
  WorkloadAttestor "unix" {
    plugin_data {
      discover_workload_path = true
      discover_workload_user = true
      discover_workload_group = true
    }
  }
}

health_checks {
  listener_enabled = true
  bind_address = "127.0.0.1"
  bind_port = "9990"  # AIDEV-NOTE: Health checks in 9xxx range like metrics
  live_path = "/live"
  ready_path = "/ready"
}

# Production telemetry
telemetry {
  Prometheus {
    host = "127.0.0.1"
    port = 9989
  }
}