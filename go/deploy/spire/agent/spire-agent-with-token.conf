# SPIRE Agent Configuration - With Join Token
# AIDEV-NOTE: This configuration includes the join token for initial registration

agent {
  data_dir = "/var/lib/spire/agent/data"
  log_level = "INFO"
  log_format = "json"
  
  # Server connection configuration
  server_address = "127.0.0.1"
  server_port = "8085"  # AIDEV-NOTE: Changed from 8081 to match new SPIRE server port
  socket_path = "/run/spire/sockets/agent.sock"
  
  # Must match the server's trust domain
  trust_domain = "development.unkey.app"
  
  # Bootstrap bundle for initial trust
  trust_bundle_path = "/etc/spire/agent/bootstrap.crt"
  
  # Workload API configuration
  authorized_delegates = []
}

plugins {
  # Join token attestation for initial registration
  NodeAttestor "join_token" {
    plugin_data {
    }
  }
  
  # Disk-based key storage
  KeyManager "disk" {
    plugin_data {
      directory = "/var/lib/spire/agent/keys"
    }
  }
  
  # Unix workload attestor for process-based identity
  WorkloadAttestor "unix" {
    plugin_data {
      discover_workload_path = true
      discover_workload_user = true
      discover_workload_group = true
    }
  }
}

health_checks {
  listener_enabled = true
  bind_address = "127.0.0.1"
  bind_port = "8084"  # AIDEV-NOTE: Changed from 8082 to avoid collision with builderd
  live_path = "/live"
  ready_path = "/ready"
}

# Telemetry for monitoring agent health
telemetry {
  Prometheus {
    host = "127.0.0.1"
    port = 9989
  }
}