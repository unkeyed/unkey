# SPIRE Agent Configuration
# Communicates with SPIRE server to obtain and rotate certificates

agent {
  data_dir = "/var/lib/spire/agent/data"
  log_level = "${UNKEY_SPIRE_LOG_LEVEL:-INFO}"
  log_format = "json"

  # Agent connects to server via HTTPS
  server_address = "${UNKEY_SPIRE_SERVER_URL:-https://localhost:8085}"
  socket_path = "/var/lib/spire/agent/agent.sock"

  trust_domain = "${UNKEY_SPIRE_TRUST_DOMAIN:-development.unkey.cloud}"

  # This file must be distributed securely to agents
  trust_bundle_path = "/etc/spire/agent/bundle.crt"

  # Allow workloads to request SVIDs without authentication
  # Security comes from workload attestation
  authorized_delegates = []

  # Enable only if needed for debugging
  # admin_socket_path = "/run/spire/agent-admin.sock"

  sync_interval = "30s"

  max_concurrent_attestations = 10
}

plugins {
  # Production should use platform-specific attestors (aws_iid, gcp_iit, etc.)
  NodeAttestor "join_token" {
    plugin_data {
      # Token provided via UNKEY_SPIRE_JOIN_TOKEN environment variable
      # Enables automatic joining on startup
    }
  }

  # Keys are automatically rotated by SPIRE
  KeyManager "disk" {
    plugin_data {
      directory = "/var/lib/spire/agent/keys"
    }
  }

  # Essential for identifying workloads by binary path and user
  WorkloadAttestor "unix" {
    plugin_data {
      discover_workload_path = true
      discover_workload_user = true
      discover_workload_group = true
    }
  }

  # Critical for identifying systemd-managed services
  WorkloadAttestor "systemd" {
    plugin_data {
      # Enable PID tracking for accurate service identification
      pid_path = "/run/spire/systemd-pids"
    }
  }

  # Only workloads from same trust domain can connect
  SVIDStore "aws_secretsmanager" {
    plugin_data {
      # Optional: Store SVIDs in AWS Secrets Manager for backup
      # region = "${AWS_REGION}"
      # secret_prefix = "spire/svids/"
    }
  }
}

health_checks {
  listener_enabled = true
  bind_address = "127.0.0.1"
  live_path = "/live"
  ready_path = "/ready"
}

telemetry {
  Prometheus {
    host = "127.0.0.1"
    port = 9989
  }

  # metric_labels = [{service = "spire-agent"}]
}
