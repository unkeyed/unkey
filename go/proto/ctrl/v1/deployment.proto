syntax = "proto3";

package ctrl.v1;

option go_package = "github.com/unkeyed/unkey/go/gen/proto/ctrl/v1;ctrlv1";

// Deployment status enum
enum DeploymentStatus {
  DEPLOYMENT_STATUS_UNSPECIFIED = 0;
  DEPLOYMENT_STATUS_PENDING = 1;
  DEPLOYMENT_STATUS_BUILDING = 2;
  DEPLOYMENT_STATUS_DEPLOYING = 3;
  DEPLOYMENT_STATUS_ACTIVE = 4;
  DEPLOYMENT_STATUS_FAILED = 5;
  DEPLOYMENT_STATUS_ARCHIVED = 6;
}

// Source type for deployment creation
enum SourceType {
  SOURCE_TYPE_UNSPECIFIED = 0;
  SOURCE_TYPE_GIT = 1;
  SOURCE_TYPE_CLI_UPLOAD = 2;
}

message CreateDeploymentRequest {
  string workspace_id = 1;
  string project_id = 2;
  string branch = 3;
  // Source information
  SourceType source_type = 4;
  string git_commit_sha = 5; // For git sources
  // Optional environment override (defaults based on branch)
  string environment_id = 7;
  // Docker image support
  string docker_image_tag = 8; // e.g. "ghcr.io/user/app:sha256..."
  // Gateway hostname for routing
  string hostname = 9;
  // Keyspace ID for authentication
  string keyspace_id = 10;
}

message CreateDeploymentResponse {
  string deployment_id = 1;
  DeploymentStatus status = 2; // Will be PENDING or BUILDING
}

message GetDeploymentRequest {
  string deployment_id = 1;
}

message GetDeploymentResponse {
  Deployment deployment = 1;
}

message Deployment {
  string id = 1;
  string workspace_id = 2;
  string project_id = 3;
  string environment_id = 4;

  // Source information
  string git_commit_sha = 5;
  string git_branch = 6;

  // Status and lifecycle
  DeploymentStatus status = 7;
  string error_message = 8; // For failed deployments

  // Configuration snapshot (resolved at creation time)
  map<string, string> environment_variables = 9;

  // Topology configuration
  Topology topology = 10;

  // Timestamps
  int64 created_at = 11;
  int64 updated_at = 12;

  // Associated hostnames for this deployment
  repeated string hostnames = 13;

  // Build information
  string rootfs_image_id = 14;
  string build_id = 15;

  // Deployment steps
  repeated DeploymentStep steps = 16;
}

message DeploymentStep {
  string status = 1;
  string message = 2;
  string error_message = 3;
  int64 created_at = 4;
}

message Topology {
  int32 cpu_millicores = 1;
  int32 memory_mb = 2;

  // Regional configuration
  repeated RegionalConfig regions = 3;

  // Runtime settings
  int32 idle_timeout_seconds = 4; // 0 means no timeout
  string health_check_path = 5;
  int32 port = 6;
}

message RegionalConfig {
  string region = 1;
  int32 min_instances = 2;
  int32 max_instances = 3;
}

service DeploymentService {
  // Create a new deployment
  rpc CreateDeployment(CreateDeploymentRequest) returns (CreateDeploymentResponse) {}

  // Get deployment details
  rpc GetDeployment(GetDeploymentRequest) returns (GetDeploymentResponse) {}
}
