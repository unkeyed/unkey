---
# ServiceAccount for the preflight
apiVersion: v1
kind: ServiceAccount
metadata:
  name: preflight
  namespace: unkey
---
# ClusterRole for the webhook to read pods and registry auth
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: preflight
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create"]
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: preflight
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: preflight
subjects:
  - kind: ServiceAccount
    name: preflight
    namespace: unkey
---
# TLS Secret for webhook is created by Tiltfile (local dev) or cert-manager (production)
# For manual setup: mkcert -cert-file tls.crt -key-file tls.key preflight.unkey.svc preflight.unkey.svc.cluster.local
#                   kubectl create secret tls preflight-tls -n unkey --cert=tls.crt --key=tls.key
---
# Deployment for the preflight
apiVersion: apps/v1
kind: Deployment
metadata:
  name: preflight
  namespace: unkey
  labels:
    app: preflight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: preflight
  template:
    metadata:
      labels:
        app: preflight
    spec:
      serviceAccountName: preflight
      containers:
        - name: webhook
          image: unkey-preflight:latest
          imagePullPolicy: IfNotPresent
          command: ["/unkey", "run", "preflight"]
          env:
            - name: WEBHOOK_PORT
              value: "8443"
            - name: WEBHOOK_TLS_CERT_FILE
              value: "/certs/tls.crt"
            - name: WEBHOOK_TLS_KEY_FILE
              value: "/certs/tls.key"
            - name: UNKEY_ENV_IMAGE
              value: "unkey-env:latest"
            - name: UNKEY_ENV_IMAGE_PULL_POLICY
              value: "Never" # Local dev uses pre-loaded images; use IfNotPresent in prod
            - name: KRANE_ENDPOINT
              value: "http://krane.unkey.svc.cluster.local:8080"
            - name: UNKEY_DEPOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: depot-credentials
                  key: token
          ports:
            - containerPort: 8443
              name: https
          volumeMounts:
            - name: tls-certs
              mountPath: /certs
              readOnly: true
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tls-certs
          secret:
            secretName: preflight-tls
---
# Service for the webhook
apiVersion: v1
kind: Service
metadata:
  name: preflight
  namespace: unkey
spec:
  selector:
    app: preflight
  ports:
    - port: 443
      targetPort: 8443
      protocol: TCP
---
# MutatingWebhookConfiguration
# caBundle must be set to mkcert's root CA:
#   cat "$(mkcert -CAROOT)/rootCA.pem" | base64 | tr -d '\n'
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: preflight
webhooks:
  - name: preflight.unkey.com
    clientConfig:
      service:
        name: preflight
        namespace: unkey
        path: /mutate
        port: 443
      caBundle: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZLRENDQTVDZ0F3SUJBZ0lSQU5IdndmanJocmkzc1RSUktKVTVJb013RFFZSktvWklodmNOQVFFTEJRQXcKZ2FzeEhqQWNCZ05WQkFvVEZXMXJZMlZ5ZENCa1pYWmxiRzl3YldWdWRDQkRRVEZBTUQ0R0ExVUVDd3czWm14dgpjbWxoYm1WcGEyVnNRRVpzYjNKcFlXNXpMVTFDVUMwekxteHZZMkZzWkc5dFlXbHVJQ2hHYkc5eWFXRnVJRVZwCmEyVnNLVEZITUVVR0ExVUVBd3crYld0alpYSjBJR1pzYjNKcFlXNWxhV3RsYkVCR2JHOXlhV0Z1Y3kxTlFsQXQKTXk1c2IyTmhiR1J2YldGcGJpQW9SbXh2Y21saGJpQkZhV3RsYkNrd0hoY05NalV3T0RBMU1UVTBPVFV3V2hjTgpNelV3T0RBMU1UVTBPVFV3V2pDQnF6RWVNQndHQTFVRUNoTVZiV3RqWlhKMElHUmxkbVZzYjNCdFpXNTBJRU5CCk1VQXdQZ1lEVlFRTEREZG1iRzl5YVdGdVpXbHJaV3hBUm14dmNtbGhibk10VFVKUUxUTXViRzlqWVd4a2IyMWgKYVc0Z0tFWnNiM0pwWVc0Z1JXbHJaV3dwTVVjd1JRWURWUVFEREQ1dGEyTmxjblFnWm14dmNtbGhibVZwYTJWcwpRRVpzYjNKcFlXNXpMVTFDVUMwekxteHZZMkZzWkc5dFlXbHVJQ2hHYkc5eWFXRnVJRVZwYTJWc0tUQ0NBYUl3CkRRWUpLb1pJaHZjTkFRRUJCUUFEZ2dHUEFEQ0NBWW9DZ2dHQkFLTmwwR2kxUEZNa3d3eHg3b2c4NE8xalhHdUIKVVJ1N3VWR3oyUHZVV2pxbm43SEtwQVovbmRZblB2ZUUrQlo0WEhmeE1TTllIVzZOWUppdVV4YVlpcEhpbVdOOApuTUt6SS9nZjBVVlVNdldTemZQSXFPSTFWYlF6Tko2djFIell4NUhidDRndnRLWEpxc3Jxbi91VzIwN25BZTBlClA1TkE1MUVISjZ4OWNnQUpZUTlSaXd2SXBZaTFZRU1ZTlhCWCtYMnQ1S3NyUHRUbW9FN09KTWQ1SiszZkljVUUKd2tqOHlKZm5Nc01BU2tsTEZuWUpEczhhOXhKUWszc0hhUmJhTVFBaDVzNWZYT0FxandodjhzS3FsZVFBMDkxSQpKVndKRlZjdkIvQXlFQ1JZdzdjVlZmWkUyTUJrdlVsSGxOOXQ5MU1kbnpGdDQvdUZTYmRJZXZiRU5wcng1K2JPCjNxUldIL0F2ZmpFditmM1ozaW4vRlBWMFhwT21TVU1XK1BjWEU2aVFhcVZWT1hOWmR1Z0dUY3pLQTZkK0dWa24KYzJFS2h4NStXalNBMEt5Q2ZFZzNLNkc0MTc3cTY4V1lxOEdYTWo3aVNrOTJVekV6TkRZYm5peklWK0UxRHJMNQo1d0ZmMzFDTURpYU5DR0ljYnR4Q2Q4dkRKWEFFQTV5Q1NVRzdsd0lEQVFBQm8wVXdRekFPQmdOVkhROEJBZjhFCkJBTUNBZ1F3RWdZRFZSMFRBUUgvQkFnd0JnRUIvd0lCQURBZEJnTlZIUTRFRmdRVS91bkZtbStIcFZjaG8xWC8KUTBOU0VhNWs5M0V3RFFZSktvWklodmNOQVFFTEJRQURnZ0dCQUppdkZXNjJIRVNjQnBUM0xjM1dMdE9LcXAwYQpaTnBFS3dIWGNwckNYSjJQdHpGWkRSaVpnQ1hHK3N5YTcrWnEvc1VYZVdSS2NZK0xkeUNRL3BUbWUzWDdwa09pCkZycEo0ZlJOeDdTdFYrVTNJUEc3TW9jSkk4NnpnVnZPZ2loU3VjRWVHY20xVHlWRGhTeTJrWldWc3luU0hzeTQKS1RuWTR5VlpVQjVHT0tBay9xM0h6c05jaHpqSS9UUkViRVFXUWh3Y3FuNkdZYjRlU0FudTZTS2dvUHEzTU9WegpzNjRaaFF4ek11QzZnZkhkV3V3bmdhdDlGVEJONWpxa0NsemtvVXREMlhjOVlOQkFZSEw3L2RQSk9kMjRjT2E5CnpONTZ0SWpVN1ZGcHdrU0RCZ25NSUFaR3BxUWVZWTNqaFdPem8wMXBJOHY1OUhFeVpnUUxtZjhvN0hHVStyaE4KU2hLdkJSQzBpS3YvYXVTYUlubUNHWVlwWk90dmtoa0hRc3AwKzVndndXVk5lYW1BSWwweEYyZEFhQkxsN2xueApnbzc5ZWJ1RU5saHgxcnB5cHBGSUEraUc4OG9tL0xrM0tQSENHUmFncVdPS0tIYVgvVXNpaHBTcVl3UUdwQVh6CkkzM2s4VnBZZTRVZDIzTzZadXdQMDlrdFFqMUU4emluMzREcjBRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
    rules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["pods"]
        scope: Namespaced
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values: ["kube-system"]
    objectSelector:
      matchExpressions:
        - key: unkey.com/inject
          operator: In
          values: ["true"]
    failurePolicy: Ignore
    reinvocationPolicy: Never
    sideEffects: NoneOnDryRun
    admissionReviewVersions: ["v1"]
    timeoutSeconds: 10
