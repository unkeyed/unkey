---
date: 2024-03-01
title: "High frequency usage based billing"
description: "Building a billing pipeline for millions of daily datapoints"
author: andreas
tags: [ "engineering" ]
---
{/* 

<p className="text-center">
TLDR: Please don't do this:
</p>
```bash
https://company.com/resource/c6b10dd3-1dcf-416c-8ed8-ae561807fcaf
``` */}



___
## Introduction

- Brief overview of the blog post's topic: usage-based billing in a serverless environment

## What is Usage-Based Billing?

- Explanation of usage-based billing
- Why it is important for our serverless environment

## Challenges with Usage-Based Billing

- Detailing the challenges we faced
- Stripe subscriptions and their rate limits
- getting up to date usage numbers
- The difficulty of collecting every event

## Our Solution: Using Tinybird for Analytics

- Introduction of Tinybird
- Why we chose to use it
- How we hooked it into our existing analytics system

### Billing Vector 1: Verifications

```sql title="Aggregating verifications per month"
SELECT
    workspaceId,
    apiId,
    keyId,
    countIfState((deniedReason = '') OR (deniedReason IS NULL)) AS success,
    countIfState(deniedReason = 'RATE_LIMITED') AS rateLimited,
    countIfState(deniedReason = 'USAGE_EXCEEDED') AS usageExceeded,
    toStartOfMonth(fromUnixTimestamp64Milli(time)) AS time
FROM key_verifications__v2
GROUP BY
    workspaceId,
    apiId,
    keyId,
    time
    ```

```sql title="Verifications by workspace"
%
SELECT
    countIfMerge(success) as success,
    countIfMerge(rateLimited) as rateLimited,
    countIfMerge(usageExceeded) as usageExceeded,
    time
FROM mv__monthly_verifications__v2
where
    workspaceId = {{ String(workspaceId, required=True) }}
    and time = makeDate({{ Int64(year) }}, {{ Int64(month) }}, 1)
group by time
```


### Billing Vector 2: Active Keys

```sql title="Aggregating keys monthly"
SELECT
    workspaceId,
    apiId,
    keyId,
    toStartOfMonth(fromUnixTimestamp64Milli(time)) AS time
FROM key_verifications__v2
GROUP BY
    workspaceId,
    apiId,
    keyId,
    time
    ```

    ```sql title="Endpoint active keys by workspace id"
    %
SELECT count(DISTINCT keyId) as keys
FROM mv__monthly_active_keys__v1
where
    workspaceId = {{ String(workspaceId, required=True) }}
    and time = makeDate({{ Int64(year) }}, {{ Int64(month) }}, 1)
group by  time
```




## Implementation Details

- Deep dive into how we implemented our solution
- Discuss any challenges faced during implementation and how we overcame them

## Results and Lessons Learned

- Analysis of the results after implementing our solution
- Lessons we learned from the process
- How we plan to improve in the future

## Conclusion

- Recap of the blog post
- An invitation for feedback and discussion